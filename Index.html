<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>App da Kika</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="App da Kika" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="application-name" content="App da Kika">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2xre/j9yR0c2zJ3sF46QeE5a/qQ6P3o9fF6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF.js para leitor de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

    <style>
/* ======================================================================= */
/* === Estilos CSS Atualizados (v26) */
/* ======================================================================= */

/* Estilos existentes */
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #FFD600;
    min-height: 100vh;
    padding: 0;
    border-radius: 0 !important;
}
.container {
    width: 100%;
    height: 100vh;
    margin: 0;
    background: white;
    border-radius: 0 !important;
    box-shadow: none;
    overflow: auto;
}
.app-header {
    background-color: #005bb5; /* A cor azul dos botões */
    color: white;
    padding: 35px;
    margin: 0 0px 20px 0px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
}
.app-header h1 {
    margin: 20;
    font-size: 45px;
}
.current-time { font-size: 18px; opacity: 0.9; }
.tab-buttons {
    display: flex;
    margin: 0 20px 20px 20px;
    gap: 10px;
    flex-wrap: wrap; /* Permite que os botões quebrem para a próxima linha se não houver espaço */
    justify-content: center;
}
.tab-buttons button {
    flex: 1 1 auto; /* Permite que os botões cresçam e encolham, mas mantendo a proporção */
    min-width: 80px; /* Garante que os botões não fiquem muito pequenos */
    padding: 10px 0;
    font-weight: 600;
    background-color: #4facfe;
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s;
}
.tab-buttons button.active { background-color: #005bb5; }
.tab-content { padding: 0 20px 30px 20px; }
.tab-content > div { display: none; }
.tab-content > div.active { display: block; }
.route-selector { margin-bottom: 30px; }
.route-selector label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: #333;
}
.route-selector select {
    width: 100%;
    padding: 15px;
    border: 2px solid #e1e5e9;
    border-radius: 10px;
    font-size: 16px;
    background: white;
    cursor: pointer;
    transition: border-color 0.3s;
}
.route-selector select:focus { outline: none; border-color: #4facfe; }
.schedule-info {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
}
.next-bus { text-align: center; margin-bottom: 25px; }
.next-bus h2 { color: #333; margin-bottom: 10px; }
.next-time {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    font-size: 36px; font-weight: bold; color: #4facfe; margin-bottom: 5px;
}
.time-remaining {
    font-size: 18px;
    color: #666;
    background: #e3f2fd;
    padding: 8px 16px;
    border-radius: 25px;
    display: inline-block;
}
.upcoming-times { margin-top: 25px; }
.upcoming-times h3 { color: #333; margin-bottom: 15px; font-size: 18px; }
.time-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 250px;
    margin: 0 auto;
}
.time-item {
    background: white;
    border: 2px solid #e1e5e9;
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: 500;
    color: #555;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.time-item.tomorrow {
    background: #fff3cd;
    border-color: #ffc107;
    color: #856404;
}
.day-indicator {
    background: #ff9800;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
    margin-bottom: 15px;
}
.no-more-buses {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 20px;
}
#map {
    width: 100%;
    height: 350px;
    border-radius: 15px;
    margin-top: 20px;
    margin-bottom: 10px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.10);
}
.action-buttons {
    display: flex;
    gap: 5px;
}
.action-buttons.centered {
     justify-content: center;
}
.action-buttons button {
    border: none;
    border-radius: 5px;
    cursor: pointer;
    padding: 5px 8px;
    color: white;
    transition: background-color 0.2s;
}
.action-buttons .btn-reminder {
    background-color: #ff9800; /* Laranja */
}
.action-buttons .btn-whatsapp {
    background-color: #25D366; /* Verde WhatsApp */
}
.action-buttons .btn-calendar {
    background-color: #f44336; /* Vermelho */
}
.action-buttons .btn-navigate {
    background-color: #2196F3;
}
.action-buttons .btn-reminder:hover { background-color: #e68900; }
.action-buttons .btn-whatsapp:hover { background-color: #128C7E; }
.action-buttons .btn-calendar:hover { background-color: #d32f2f; }
.action-buttons .btn-navigate:hover { background-color: #1976D2; }
.whatsapp-share-btn {
    font-size: 14px;
    padding: 5px 10px;
    border-radius: 8px;
    border: none;
    background-color: #25D366;
    color: white;
    cursor: pointer;
}
.reminder-list, .poi-list {
    list-style: none;
    padding: 0;
}
.reminder-item, .poi-item {
    background: #e3f2fd;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}
.poi-item {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    background-color: #f8f9fa;
}
.reminder-details, .poi-details {
    text-align: left;
    flex-grow: 1;
}
.reminder-details h4, .poi-details h4 {
    margin: 0 0 5px 0;
    color: #333;
}
.reminder-details p, .poi-details p {
    margin: 0;
    font-size: 14px;
    color: #666;
}
.reminder-remove {
    background: #e91e63;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.reminder-remove:hover {
    background: #c2185b;
}
.navigation-panel {
    position: static;
    width: 100%;
    background: #ffffff;
    color: #333;
    padding: 8px;
    border-radius: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin-top: 10px;
    z-index: 1000;
    overflow-y: auto;
    font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
    display: none;
}
.navigation-panel.active {
    display: block;
}
.nav-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 15px;
}
.nav-title {
    font-size: 20px;
    font-weight: bold;
    color: #4285F4;
}
.nav-close {
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 24px;
    transition: color 0.2s;
    line-height: 1;
}
.nav-close:hover {
    color: #333;
}
.nav-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    font-size: 14px;
    color: #555;
}
.nav-distance, .nav-duration {
    background: #f1f1f1;
    padding: 8px 12px;
    border-radius: 15px;
}
.nav-instruction {
    background: #f9f9f9;
    border: 1px solid #e0e0e0;
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 3px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    background: rgba(255, 255, 255, 0.25);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.nav-instruction-icon {
    font-size: 18px;
    width: 20px;
    text-align: center;
    color: #4285F4;
}
.nav-instruction-text {
    flex: 1;
    font-size: 13px;
    line-height: 1.3;
}
.nav-instruction-distance {
    font-size: 14px;
    opacity: 0.8;
}
.nav-controls {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
.nav-controls button {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
}
.nav-controls button:active {
    transform: scale(0.98);
}
.nav-recalculate {
    background: #FF9800;
    color: white;
}
.nav-recalculate:hover {
    background: #e68900;
}
.nav-stop {
    background: #F44336;
    color: white;
}
.nav-stop:hover {
    background: #d32f2f;
}
.gps-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    opacity: 0.8;
    margin-top: 10px;
}
.gps-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4caf50;
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.5; }
    100% { transform: scale(1); opacity: 1; }
}
/* Estilos do modal */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    backdrop-filter: blur(5px);
    padding-top: 60px;
}
.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 400px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}
.close-button:hover,
.close-button:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}
/* Novos estilos para a tab PDF */
#horariosPdf .pdf-nav, #pdfReader .pdf-nav {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
#horariosPdf .pdf-nav button, #pdfReader .pdf-nav button {
    padding: 10px 15px;
    border: 2px solid #e1e5e9;
    border-radius: 10px;
    background-color: #f8f9fa;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}
#horariosPdf .pdf-nav button:hover, #pdfReader .pdf-nav button:hover {
    border-color: #4facfe;
    background-color: #e3f2fd;
}
#horariosPdf .pdf-nav button.active, #pdfReader .pdf-nav button.active {
    background-color: #4facfe;
    color: white;
    border-color: #005bb5;
}
#horariosPdf .pdf-image-container {
    text-align: center;
}
#pdf-image {
    max-width: 100%;
    border-radius: 10px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}
 /* Estilos do indicador de status de localização */
.location-status {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    z-index: 999;
    display: none;
}
.location-status.active {
    display: flex;
    align-items: center;
    gap: 5px;
}
.location-status .status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4caf50;
}
.location-status.network .status-indicator {
    background: #ff9800;
}
.location-status.ip .status-indicator {
    background: #f44336;
}
.location-status.default .status-indicator {
    background: #9e9e9e;
}
@media (max-width: 480px) {
    .container { margin: 0; border-radius: 0; }
    .banner { padding: 15px; height: 120px; }
    .header { padding: 20px 15px; }
    .tab-buttons { margin: 0 10px 20px 10px; gap: 5px; }
    .tab-buttons button { padding: 8px 0; font-size: 14px; }
    .tab-content { padding: 0 10px 20px 10px; }
    #map { height: 250px; }
    .time-item { flex-direction: column; align-items: flex-start; gap: 5px; padding: 10px; }
    .time-item .action-buttons { margin-top: 5px; }
    .time-list { max-width: none; }
}
.nav-instruction {
        padding: 12px;
        gap: 10px;
    }
    .nav-instruction-icon {
        font-size: 20px;
        width: 30px;
    }
    .nav-instruction-text {
        font-size: 14px;
    }
/* Estilos para a lista de favoritos e to-do */
.poi-item, .task-item {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}

.task-item.completed .task-details h4,
.task-item.completed .task-details p {
    text-decoration: line-through;
    color: #999;
}

.poi-item .action-buttons,
.task-item .task-actions {
    display: flex;
    gap: 5px;
}

.poi-item .action-buttons button,
.task-item .task-actions button {
    border: none;
    border-radius: 5px;
    cursor: pointer;
    padding: 8px 10px;
    color: white;
    transition: background-color 0.2s;
    font-size: 14px;
}

/* Checkbox para seleção de POI */
.poi-checkbox {
    width: 20px;
    height: 20px;
    margin-right: 10px;
    cursor: pointer;
}

/* Estilos dos botões de ação na lista de tarefas */
.btn-task-complete { background-color: #4caf50; }
.btn-task-delete { background-color: #f44336; }
.btn-task-reminder { background-color: #ff9800; }
.btn-task-whatsapp { background-color: #25D366; }
.btn-task-navigate { background-color: #2196f3; }
.btn-task-calendar { background-color: #f44336; } /* Adicionado para ICS */


/* Estilos para a To-Do List */
.to-do-sub-content > div {
    display: none;
}
.to-do-sub-content > div.active {
    display: block;
}
/* Corrigido o seletor para os botões da sub-aba */
#toDoList .tab-buttons button {
    flex: 1;
    padding: 10px 0;
    font-weight: 600;
    /* Estilo conforme a imagem: fundo mais claro, texto escuro */
    background-color: #e3f2fd; /* Azul claro */
    border: none;
    border-radius: 10px;
    color: #333; /* Texto escuro */
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
}
#toDoList .tab-buttons button.active {
    background-color: #4facfe; /* Cor ativa para sub-abas (azul vibrante) */
    color: white; /* Texto branco */
}

/* Estilos do Calendário */
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-size: 1.2rem;
    font-weight: bold;
}
.calendar-header button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    color: #4facfe;
}
.calendar-grid-header, .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
}
.calendar-grid-header div {
    font-weight: bold;
    padding: 5px;
    color: #555;
}
.calendar-day {
    position: relative;
    padding: 10px 5px;
    height: 60px;
    border: 1px solid #e1e5e9;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
}
.calendar-day.empty {
    background-color: #f0f0f0; /* Cor para dias vazios */
}
.calendar-day.today {
    background-color: #e3f2fd;
    border: 2px solid #4facfe;
}
.calendar-day span {
    font-weight: bold;
    color: #333;
}
.calendar-event {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin: 2px auto;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.no-items {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 20px;
}

/* Estilos para os botões de ação nos modais de tarefa */
#taskDetailsModal .task-actions button {
    display: flex; /* Para alinhar ícone e texto */
    align-items: center;
    justify-content: center;
    gap: 8px; /* Espaçamento entre ícone e texto */
    padding: 10px 15px; /* Aumentar padding para melhor clique */
    border-radius: 8px; /* Cantos mais arredondados */
    font-size: 15px; /* Tamanho da fonte */
    font-weight: bold; /* Negrito */
    margin-bottom: 10px; /* Espaçamento entre botões */
    width: 100%; /* Ocupar largura total */
}

/* Estilo para os detalhes do POI na lista para que o checkbox não se misture */
.poi-item .poi-details {
    flex-grow: 1;
    margin-right: 10px; /* Espaçamento entre detalhes e botões/checkbox */
}

/* Novo estilo para o modal de seleção de meio de transporte */
#transportModeModal .modal-content {
    max-width: 350px;
}
#transportModeModal .transport-options button {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f0f0f0;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    justify-content: center;
}
#transportModeModal .transport-options button:hover {
    background-color: #e0e0e0;
}
#transportModeModal .transport-options button i {
    font-size: 20px;
    color: #4facfe;
}
/* Estilos para os botões de link e mapa nos pontos de interesse */
.btn-link {
    background-color: #4caf50; /* Verde */
    color: white;
}
.btn-link:hover {
    background-color: #43a047;
}
.btn-map-pin {
    background-color: #f44336; /* Vermelho */
    color: white;
}
.btn-map-pin:hover {
    background-color: #d32f2f;
}

/* Estilo para o campo de cor da tarefa */
#taskColorSelect {
    -webkit-appearance: none; /* Remove o estilo padrão do navegador para selects */
    -moz-appearance: none;
    appearance: none;
    background-image: none; /* Remove a seta padrão */
    text-indent: 1px;
    text-overflow: '';
}
#taskColorSelect option {
    color: black; /* Garante que o texto das opções seja legível */
    background-color: white;
}

/* ======================================================================= */
/* === NOVOS ESTILOS PARA AS NOVAS FUNCIONALIDADES ======================= */
/* ======================================================================= */

/* --- Estilos da Aba de Notas --- */
#notes.active {
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.note-form, .notes-list-container {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 15px;
}
.note-form input, .note-form textarea {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ddd;
    margin-bottom: 10px;
}
.note-form button {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: none;
    background-color: #4facfe;
    color: white;
    font-weight: bold;
    cursor: pointer;
}
.note-item {
    background: white;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.note-item h4 {
    margin-bottom: 5px;
}
.note-item p {
    white-space: pre-wrap; /* Mantém a formatação do texto */
    color: #555;
    margin-bottom: 10px;
}
.note-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}
.note-actions button {
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: white;
}
.btn-note-task { background-color: #4caf50; }
.btn-note-delete { background-color: #f44336; }
.btn-note-edit { background-color: #ffc107; }

/* --- Estilos da Aba de Meteorologia --- */
#weather {
    text-align: center;
}
.weather-search {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
.weather-search input {
    flex-grow: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 10px;
}
.weather-search button {
    padding: 0 15px;
    border: none;
    border-radius: 10px;
    background-color: #4facfe;
    color: white;
    cursor: pointer;
}
.weather-info {
    background: #e3f2fd;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 20px; /* Adicionado espaço para a previsão */
}
.weather-info h3 {
    font-size: 24px;
    margin-bottom: 10px;
}
.weather-info .temp {
    font-size: 48px;
    font-weight: bold;
    margin: 10px 0;
}
.weather-info .description {
    font-size: 18px;
    text-transform: capitalize;
}
.weather-icon {
    width: 100px;
    height: 100px;
}
.weather-forecast {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    overflow-x: auto; /* Permite scroll horizontal em ecrãs pequenos */
    padding: 10px 0;
}
.forecast-day {
    flex: 0 0 80px; /* Não cresce, não encolhe, base de 80px */
    padding: 10px;
    background: #f8f9fa;
    border-radius: 10px;
    text-align: center;
}
.forecast-day h4 {
    font-size: 14px;
    margin-bottom: 5px;
}
.forecast-day .fas {
    font-size: 24px;
    color: #4facfe;
    margin: 5px 0;
}
.forecast-day .temps {
    font-size: 12px;
}
.forecast-day .temps .max {
    font-weight: bold;
}
.forecast-day .temps .min {
    opacity: 0.7;
}


/* --- Estilos da Aba de Despesas --- */
#expenses .tab-buttons button, #calculator .tab-buttons button, #timer .tab-buttons button, #converter .tab-buttons button {
    background-color: #e3f2fd;
    color: #333;
}
#expenses .tab-buttons button.active, #calculator .tab-buttons button.active, #timer .tab-buttons button.active, #converter .tab-buttons button.active {
    background-color: #4facfe;
    color: white;
}
.expense-form-container, .category-manager-container, .expense-view-container {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 15px;
    margin-top: 20px;
}
.expense-form, .category-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.expense-form input, .expense-form select, .category-form input {
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ddd;
}
.expense-form button, .category-form button {
    padding: 12px;
    border-radius: 10px;
    border: none;
    background-color: #4facfe;
    color: white;
    font-weight: bold;
    cursor: pointer;
}
.category-list {
    list-style: none;
    padding: 0;
    margin-top: 10px;
}
.category-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: white;
    border-radius: 8px;
    margin-bottom: 5px;
}
/* === CORREÇÃO: Estilos dos botões de categoria para corresponder aos de despesa === */
.category-item .category-actions {
    display: flex;
    gap: 5px;
}
.category-item .category-actions button {
    padding: 6px 10px;
    border-radius: 5px;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 14px;
}
.category-item .btn-edit-category {
    background-color: #ffc107; /* Amarelo para editar */
}
.category-item .btn-delete-category {
    background-color: #f44336; /* Vermelho para apagar */
}
.expense-view-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}
.expense-view-controls button {
    padding: 8px 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
}
.expense-view-controls button.active {
    background-color: #4facfe;
    color: white;
}
.expense-list {
    list-style: none;
    padding: 0;
}
.expense-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: white;
    border-radius: 8px;
    margin-bottom: 5px;
}
.expense-total {
    margin-top: 20px;
    text-align: right;
    font-size: 1.2rem;
    font-weight: bold;
}
/* Estilos para o modal de edição de despesas */
#editExpenseModal .modal-content {
    max-width: 450px;
    text-align: left;
}
#editExpenseModal .expense-edit-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}
#editExpenseModal .expense-edit-form input,
#editExpenseModal .expense-edit-form select {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
}
#editExpenseModal .expense-edit-form button {
    padding: 12px;
    border-radius: 8px;
    border: none;
    background-color: #4facfe;
    color: white;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
}
.expense-item .expense-actions {
    display: flex;
    gap: 5px;
}
.expense-item .expense-actions button {
    padding: 6px 10px;
    border-radius: 5px;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 14px;
}
.expense-item .btn-edit-expense {
    background-color: #ffc107; /* Amarelo para editar */
}
.expense-item .btn-delete-expense {
    background-color: #f44336; /* Vermelho para apagar */
}

/* --- Estilos da Calculadora --- */
#calculator {
    background: #f0f2f5;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    max-width: 500px;
    margin: 0 auto;
}
.calculator-display {
    width: 100%;
    background: #222;
    color: #fff;
    text-align: right;
    padding: 20px;
    font-size: 2.5em;
    border-radius: 10px;
    margin-bottom: 20px;
    overflow-x: auto;
}
.calculator-buttons {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
}
.calculator-buttons button {
    padding: 20px;
    font-size: 1.5em;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: background-color 0.2s;
}
.calculator-buttons button:hover {
    background: #f0f0f0;
}
.calculator-buttons .operator {
    background: #ff9f40;
    color: white;
}
.calculator-buttons .function {
    background: #a5a5a5;
    color: white;
}
.calculator-buttons .clear {
    background: #f44336;
    color: white;
    grid-column: span 2;
}
.calculator-buttons .equals {
    background: #4caf50;
    color: white;
    grid-column: span 2;
}

/* --- Estilos do Temporizador/Cronómetro --- */
.timer-container, .stopwatch-container, .converter-container {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 15px;
    margin-top: 20px;
    text-align: center;
}
.timer-display, .stopwatch-display {
    font-size: 4em;
    font-weight: bold;
    margin: 20px 0;
    color: #333;
}
.timer-inputs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}
.timer-inputs input {
    width: 70px;
    padding: 10px;
    font-size: 1.2em;
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 8px;
}
.timer-controls button, .stopwatch-controls button {
    padding: 10px 20px;
    margin: 0 5px;
    font-size: 1em;
    border-radius: 8px;
    border: none;
    color: white;
    cursor: pointer;
}
.timer-controls .start, .stopwatch-controls .start { background-color: #4caf50; }
.timer-controls .pause, .stopwatch-controls .pause { background-color: #ffc107; }
.timer-controls .reset, .stopwatch-controls .reset { background-color: #f44336; }

/* --- Estilos do Conversor --- */
.converter-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
}
.converter-row {
    display: flex;
    gap: 10px;
    align-items: center;
    width: 100%;
    justify-content: center;
}
.converter-row input, .converter-row select {
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 1em;
}
.converter-result {
    margin-top: 20px;
    font-size: 1.5em;
    font-weight: bold;
}
.currency-manager {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}
.currency-rate-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    background: #fff;
    border-radius: 8px;
    margin-bottom: 5px;
}

/* --- Estilos do Leitor de PDF --- */
#pdf-loader {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}
#pdf-url-input {
    flex-grow: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
}
#pdf-load-btn {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background-color: #4caf50;
    color: white;
    cursor: pointer;
}
#pdf-viewer-container {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    background: #eee;
    margin-top: 10px;
}
#pdf-viewer {
    max-width: 100%;
}
#pdf-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-top: 10px;
}
#pdf-controls button {
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    background-color: #2196f3;
    color: white;
    cursor: pointer;
}
#pdf-page-info {
    font-weight: bold;
}

/* Centralizar textos */
#horarios h3, #toDoList h3, #toDoList h4, #notes h3, #expenses h3, #expenses h4, #calculator h3, #timer h3, #converter h3, #lembretes h3, #horariosPdf h3, #horariosPdf h4, #pdfReader h3 {
    text-align: center;
}

.nav-title {
    text-align: center;
    width: 100%;
}
.search-container {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}
#search-input {
    flex-grow: 1;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #ddd;
    font-size: 16px;
}
#search-button {
    padding: 12px 15px;
    border: none;
    border-radius: 10px;
    background-color: #2196F3;
    color: white;
    cursor: pointer;
    font-size: 16px;
}
    </style>
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

<script>
    // Configuração do seu projeto Firebase
    // SUBSTITUA os valores abaixo com a sua própria configuração do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCg0UbyGcxEwhd_GlQNggj4e9pAkisLXHA",
        authDomain: "app-da-kika.firebaseapp.com",
        projectId: "app-da-kika",
        storageBucket: "app-da-kika.firebasestorage.app",
        messagingSenderId: "875403627280",
        appId: "Y1:875403627280:web:b9b5c11c4ae981eaa7b395"
    };

    // Inicializa o Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    // Lida com o pedido de permissão e obtém o token
    // Esta função pede permissão ao utilizador para enviar notificações
    function getToken() {
        if ('serviceWorker' in navigator) {
            messaging.requestPermission()
                .then(() => {
                    return messaging.getToken();
                })
                .then((token) => {
                    console.log('FCM Token:', token);
                    // Aqui pode enviar este token para o seu servidor
                    // para associá-lo ao utilizador.
                })
                .catch((err) => {
                    console.log('Não foi possível obter o token:', err);
                });
        }
    }

    // Chama a função para obter o token quando a página carrega
    getToken();

    // Lida com a receção de mensagens push enquanto a app está aberta
    messaging.onMessage((payload) => {
        console.log('Mensagem recebida em foreground:', payload);
        // Exiba a notificação na tela
        const notificationTitle = payload.notification.title;
        const notificationOptions = {
            body: payload.notification.body,
            icon: '/firebase-logo.png' // Substitua pelo seu ícone
        };
        new Notification(notificationTitle, notificationOptions);
    });

    // OneSignal - Este código irá inicializar o OneSignal na sua aplicação
    // SUBSTITUA o valor de 'app_id' com o seu OneSignal App ID
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function() {
        OneSignal.init({
            app_id: "09cf47e1-545a-4a0b-9873-f09cc9a71707",
            // A sua configuração de service worker será tratada pelo nosso ficheiro personalizado
            serviceWorkerUpdaterPath: 'OneSignalSDK.js' 
        });
    });

</script>

</head>
<body>
    <!-- Indicador de status de localização -->
    <div id="locationStatus" class="location-status">
        <div class="status-indicator"></div>
        <span id="locationStatusText">GPS ativo</span>
    </div>

    <div class="container">
        <div class="app-header">
            <h1>App da Kika</h1>
            <div class="current-time" id="currentTime"></div>
        </div>

        <div class="tab-buttons">
            <button id="btnHorarios" class="active" onclick="showTab('horarios')"><i class="fa-solid fa-bus"></i> Horários</button>
            <button id="btnMeteorologia" onclick="showTab('weather')"><i class="fa-solid fa-cloud-sun"></i> Meteorologia</button>
            <button id="btnToDoList" onclick="showTab('toDoList')"><i class="fa-solid fa-list-check"></i> To-Do List</button>
            <button id="btnNotas" onclick="showTab('notes')"><i class="fa-solid fa-note-sticky"></i> Notas</button>
            <button id="btnDespesas" onclick="showTab('expenses')"><i class="fa-solid fa-wallet"></i> Despesas</button>
            <button id="btnMapa" onclick="showTab('mapa')"><i class="fa-solid fa-map-location-dot"></i> Mapa</button>
            <button id="btnPontosDeInteresse" onclick="showTab('pontosDeInteresse')"><i class="fa-solid fa-star"></i> Locais</button>
            <button id="btnLembretes" onclick="showTab('lembretes')"><i class="fa-solid fa-bell"></i> Lembretes</button>
            <button id="btnCalculadora" onclick="showTab('calculator')"><i class="fa-solid fa-calculator"></i> Calculadora</button>
            <button id="btnTemporizador" onclick="showTab('timer')"><i class="fa-solid fa-stopwatch-20"></i> Temporizador</button>
            <button id="btnConversor" onclick="showTab('converter')"><i class="fa-solid fa-right-left"></i> Conversor</button>
            <button id="btnHorariosPdf" onclick="showTab('horariosPdf')"><i class="fa-solid fa-file-pdf"></i> Horários PDF</button>
            <button id="btnPdfReader" onclick="showTab('pdfReader')"><i class="fa-solid fa-book-open"></i> Leitor PDF</button>
        </div>

        <div class="tab-content">
            <div id="horarios" class="active">
                <div class="route-selector">
                    <label for="routeSelect">Selecione a rota:</label>
                    <select id="routeSelect"></select>
                </div>
                <div id="scheduleResult"></div>
            </div>

            <!-- Conteúdo da aba "To-Do List" -->
            <div id="toDoList">
                <!-- Botões da To-Do List (sub-abas) -->
                <div class="tab-buttons" style="margin-bottom: 20px;">
                    <button id="btnTaskFormTab" class="active" onclick="showToDoSubTab('taskFormTab')">Inserir Tarefa</button>
                    <button id="btnCalendarTab" onclick="showToDoSubTab('calendarTab')">Calendário</button>
                    <button id="btnTaskListTab" onclick="showToDoSubTab('taskListTab')">Lista</button>
                </div>

                <div class="to-do-sub-content">
                    <!-- Conteúdo para o formulário de inserção de tarefas -->
                    <div id="taskFormTab" class="active">
                        <h3 style="margin-bottom: 1rem;">Inserir Nova Tarefa</h3>
                        <form id="taskForm" style="display: flex; flex-direction: column; gap: 15px;">
                            <input type="text" id="taskNameInput" placeholder="Nome da Tarefa" required style="padding: 10px; border-radius: 10px; border: 1px solid #ddd;">
                            <textarea id="taskDescriptionInput" placeholder="Descrição (opcional)" rows="3" style="padding: 10px; border-radius: 10px; border: 1px solid #ddd;"></textarea>
                            <input type="date" id="taskDateInput" required style="padding: 10px; border-radius: 10px; border: 1px solid #ddd;">
                            <input type="time" id="taskTimeInput" style="padding: 10px; border-radius: 10px; border: 1px solid #ddd;">
                            <select id="taskPrioritySelect" style="padding: 10px; border-radius: 10px; border: 1px solid #ddd;">
                                <option value="nao-urgente">Não Urgente</option>
                                <option value="urgente">Urgente</option>
                                <option value="prioritaria">Prioritária</option>
                                <option value="social">Social (Aniversário)</option>
                                <option value="viagem">Viagem</option>
                            </select>
                            <select id="taskColorSelect" style="padding: 10px; border-radius: 10px; border: 1px solid #ddd;">
                                <option value="#4caf50">Verde (Não Urgente)</option>
                                <option value="#ff9800">Amarelo (Urgente)</option>
                                <option value="#f44336">Vermelho (Prioritária)</option>
                                <option value="#2196f3">Azul (Social)</option>
                                <option value="#FFD600">Amarelo (Viagem)</option>
                            </select>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="taskIsTravel">
                                <label for="taskIsTravel">É uma viagem?</label>
                            </div>
                            <input type="text" id="taskLatInput" placeholder="Latitude (apenas para viagens)" style="padding: 10px; border-radius: 10px; border: 1px solid #ddd;">
                            <input type="text" id="taskLngInput" placeholder="Longitude (apenas para viagens)" style="padding: 10px; border-radius: 10px; border: 1px solid #ddd;">
                            <button type="button" onclick="addTask()" class="btn-primary" style="padding: 15px; border-radius: 10px; border: none; background-color: #4facfe; color: white; font-weight: bold; cursor: pointer;">Adicionar Tarefa</button>
                        </form>
                    </div>

                    <!-- Conteúdo para o Calendário -->
                    <div id="calendarTab" class="to-do-sub-tab">
                        <h3 style="margin-bottom: 1rem;">Calendário de Tarefas</h3>
                        <div class="calendar-header">
                            <button onclick="prevMonth()"><i class="fas fa-chevron-left"></i></button>
                            <h4 id="currentMonthYear"></h4>
                            <button onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar-grid-header">
                            <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div><div>Dom</div>
                        </div>
                        <div id="calendarBody" class="calendar-grid">
                            <!-- Dias do calendário serão gerados aqui -->
                        </div>
                    </div>

                    <!-- Conteúdo para a lista de tarefas -->
                    <div id="taskListTab" class="to-do-sub-tab">
                        <h3 style="margin-bottom: 1rem;">Lista de Tarefas</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <label for="taskSortSelect">Ordenar por:</label>
                            <select id="taskSortSelect" onchange="renderTaskList()" style="padding: 8px; border-radius: 8px;">
                                <option value="chronological">Cronológica</option>
                                <option value="priority">Prioridade</option>
                            </select>
                        </div>
                        <ul class="task-list" id="taskList">
                            <!-- A lista de tarefas será renderizada aqui pelo JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
            
            <div id="notes">
                <div class="note-form">
                    <h3>Nova Nota</h3>
                    <input type="text" id="noteTitleInput" placeholder="Título da Nota">
                    <textarea id="noteContentInput" rows="5" placeholder="Escreva a sua nota aqui..."></textarea>
                    <button onclick="saveNote()">Guardar Nota</button>
                </div>
                <div class="notes-list-container">
                    <h3>Notas Guardadas</h3>
                    <div id="notesList">
                        <!-- As notas salvas aparecerão aqui -->
                    </div>
                </div>
            </div>

            <div id="weather">
                <h3>Previsão do Tempo</h3>
                <div class="weather-search">
                    <input type="text" id="citySearchInput" placeholder="Pesquisar por cidade...">
                    <button onclick="getWeatherBySearch()"><i class="fas fa-search"></i></button>
                    <button onclick="getWeatherByCurrentLocation()" title="Usar localização atual"><i class="fas fa-map-marker-alt"></i></button>
                </div>
                <div id="weatherInfoContainer">
                    <!-- O conteúdo será gerado dinamicamente pelo JavaScript -->
                </div>
            </div>

            <div id="expenses">
                <div class="tab-buttons" style="margin-bottom: 20px;">
                    <button class="active" onclick="showExpenseSubTab('addExpenseTab')">Adicionar Despesa</button>
                    <button onclick="showExpenseSubTab('viewExpensesTab')">Ver Despesas</button>
                    <button onclick="showExpenseSubTab('manageCategoriesTab')">Gerir Categorias</button>
                </div>
                <div class="expense-sub-content">
                    <div id="addExpenseTab" class="active">
                        <div class="expense-form-container">
                            <h3>Adicionar Nova Despesa</h3>
                            <form id="expenseForm" class="expense-form">
                                <input type="number" id="expenseAmountInput" placeholder="Valor (€)" step="0.01" required>
                                <input type="text" id="expenseDescriptionInput" placeholder="Descrição" required>
                                <select id="expenseCategorySelect" required>
                                    <!-- Categorias carregadas aqui -->
                                </select>
                                <input type="date" id="expenseDateInput" required>
                                <button type="button" onclick="addExpense()">Adicionar Despesa</button>
                            </form>
                        </div>
                    </div>
                    <div id="viewExpensesTab" style="display: none;">
                        <div class="expense-view-container">
                            <h3>Visualizar Despesas</h3>
                            <div class="expense-view-controls">
                                <button id="viewDailyBtn" class="active" onclick="renderExpenses('daily')">Diário</button>
                                <button id="viewWeeklyBtn" onclick="renderExpenses('weekly')">Semanal</button>
                                <button id="viewMonthlyBtn" onclick="renderExpenses('monthly')">Mensal</button>
                                <button id="viewAnnuallyBtn" onclick="renderExpenses('annually')">Anual</button>
                            </div>
                            <h4 id="expensePeriodTitle">Despesas de Hoje</h4>
                            <canvas id="expenseChart" style="margin-bottom: 20px;"></canvas>
                            <ul id="expenseList" class="expense-list">
                                <!-- Lista de despesas aqui -->
                            </ul>
                            <div id="expenseTotal" class="expense-total">
                                <!-- Total das despesas aqui -->
                            </div>
                        </div>
                    </div>
                    <div id="manageCategoriesTab" style="display: none;">
                        <div class="category-manager-container">
                            <h3>Gerir Categorias</h3>
                            <form id="categoryForm" class="category-form">
                                <input type="text" id="newCategoryInput" placeholder="Nova categoria">
                                <button type="button" onclick="addExpenseCategory()">Adicionar Categoria</button>
                            </form>
                            <h4>Categorias Existentes</h4>
                            <ul id="categoryList" class="category-list">
                                <!-- Lista de categorias aqui -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="horariosPdf">
                <h3>Horários em PDF</h3>
                <div class="pdf-nav" id="pdf-nav">
                    <!-- Os botões PDF serão renderizados aqui dinamicamente -->
                </div>
                <div class="pdf-image-container">
                    <img id="pdf-image" src="" alt="Horário em formato PDF">
                </div>
            </div>
            
            <div id="pdfReader">
                 <h3>Leitor de PDF</h3>
                <div id="pdf-loader">
                    <input type="text" id="pdf-url-input" placeholder="Cole o URL do PDF aqui...">
                    <button id="pdf-load-btn" onclick="loadPdfFromUrl()">Carregar PDF</button>
                </div>
                <div id="pdf-viewer-container" style="display: none;">
                    <div id="pdf-controls">
                        <button id="pdf-prev"><i class="fas fa-arrow-left"></i> Anterior</button>
                        <span id="pdf-page-info">Página <span id="pdf-page-num"></span> de <span id="pdf-page-count"></span></span>
                        <button id="pdf-next">Seguinte <i class="fas fa-arrow-right"></i></button>
                    </div>
                    <canvas id="pdf-viewer"></canvas>
                </div>
            </div>

            <div id="lembretes">
                <h3>Meus Lembretes</h3>
                <ul class="reminder-list" id="reminderList"></ul>
            </div>

            <div id="pontosDeInteresse">
                <h2 style="font-size: 1.5rem; margin-bottom: 1rem; text-align: center;">Pontos de Interesse</h2>
                <div class="search-container" style="margin-bottom: 15px;">
                    <input type="text" id="poiSearchInput" placeholder="Pesquisar ponto de interesse..." style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #e1e5e9; font-size: 16px;" oninput="renderPontosDeInteresse()">
                </div>
                <div class="filter-and-route-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <select id="poiFilterSelect" onchange="renderPontosDeInteresse()" style="padding: 8px; border-radius: 8px;">
                        <option value="all">Todos</option>
                        <option value="selected">Selecionados</option>
                        <option value="unselected">Não Selecionados</option>
                    </select>
                    <button class="btn-primary" onclick="createRouteFromSelectedPois()" style="padding: 10px 15px; border-radius: 10px; border: none; background-color: #4facfe; color: white; font-weight: bold; cursor: pointer;">
                        <i class="fas fa-route"></i> Calcular Rota
                    </button>
                </div>
                <ul class="poi-list" id="poiList"></ul>
            </div>

            <div id="mapa">
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Pesquisar um local...">
                    <button id="search-button" onclick="searchMapLocation()"><i class="fas fa-search"></i></button>
                </div>
                <div id="map"></div>
                <div id="navigationPanel" class="navigation-panel">
                    <div class="nav-header">
                        <div class="nav-title">Navegação</div>
                        <button class="nav-close" onclick="stopNavigation()">&times;</button>
                    </div>
                    <div class="nav-info">
                        <div class="nav-distance" id="navDistance">0 km</div>
                        <div class="nav-duration" id="navDuration">0 min</div>
                    </div>
                    <div id="navInstructions">
                        <!-- As instruções aparecerão aqui -->
                    </div>
                    <div class="nav-controls">
                        <button class="nav-recalculate" onclick="recalculateRoute()">
                            <i class="fa-solid fa-route"></i> Recalcular
                        </button>
                        <button class="nav-stop" onclick="stopNavigation()">
                            <i class="fa-solid fa-stop"></i> Parar
                        </button>
                    </div>
                    <div class="gps-status">
                        <div class="gps-indicator"></div>
                        GPS ativo - Localização atualizada
                    </div>
                </div>
            </div>
            
            <!-- ======================================================================= -->
            <!-- === NOVAS ABAS ======================================================== -->
            <!-- ======================================================================= -->
            
            <div id="calculator">
                <h3>Calculadora Científica</h3>
                <div class="calculator-container">
                    <div id="calculatorDisplay" class="calculator-display">0</div>
                    <div class="calculator-buttons">
                        <button onclick="calculatorInput('sin(')" class="function">sin</button>
                        <button onclick="calculatorInput('cos(')" class="function">cos</button>
                        <button onclick="calculatorInput('tan(')" class="function">tan</button>
                        <button onclick="calculatorInput('Math.log10(')" class="function">log</button>
                        <button onclick="calculatorInput('Math.sqrt(')" class="function">√</button>
                        <button onclick="calculatorInput('(')" class="operator">(</button>
                        <button onclick="calculatorInput(')')" class="operator">)</button>
                        <button onclick="calculatorInput('**')" class="operator">x^y</button>
                        <button onclick="calculatorInput('Math.PI')" class="operator">π</button>
                        <button onclick="calculatorInput('%')" class="operator">%</button> 
                        <button onclick="calculatorInput('+')" class="operator">+</button>
                        <button onclick="calculatorInput('-')" class="operator">-</button>
                        <button onclick="calculatorInput('*')" class="operator">×</button>
                        <button onclick="calculatorInput('/')" class="operator">÷</button>
                        <button onclick="calculatorInput('.')" class="operator">.</button>
                        <button onclick="calculatorInput('9')">9</button>
                        <button onclick="calculatorInput('8')">8</button>
                        <button onclick="calculatorInput('7')">7</button>
                        <button onclick="calculatorInput('6')">6</button>
                        <button onclick="calculatorInput('5')">5</button>
                        <button onclick="calculatorInput('4')">4</button>
                        <button onclick="calculatorInput('3')">3</button>
                        <button onclick="calculatorInput('2')">2</button>
                        <button onclick="calculatorInput('1')">1</button>
                        <button onclick="calculatorInput('0')">0</button>
                        <button onclick="calculateResult()" class="equals">=</button>
                        <button onclick="calculatorClear()" class="clear">C</button>
                        <button onclick="calculatorBackspace()" class="function">⌫</button>
                    </div>
                </div>
            </div>

            <div id="timer">
                 <div class="tab-buttons" style="margin-bottom: 20px;">
                    <button class="active" onclick="showTimerSubTab('timerTab')">Temporizador</button>
                    <button onclick="showTimerSubTab('stopwatchTab')">Cronómetro</button>
                </div>
                <div id="timerTab" class="active">
                    <h3>Temporizador</h3>
                    <div class="timer-container">
                        <div id="timerDisplay" class="timer-display">00:00:00</div>
                        <div class="timer-inputs">
                            <input type="number" id="timerHours" placeholder="HH" min="0" max="23">
                            <input type="number" id="timerMinutes" placeholder="MM" min="0" max="59">
                            <input type="number" id="timerSeconds" placeholder="SS" min="0" max="59">
                        </div>
                        <div class="timer-controls">
                            <button class="start" onclick="startTimer()">Iniciar</button>
                            <button class="pause" onclick="pauseTimer()">Pausar</button>
                            <button class="reset" onclick="resetTimer()">Resetar</button>
                        </div>
                    </div>
                </div>
                <div id="stopwatchTab" style="display: none;">
                    <h3>Cronómetro</h3>
                    <div class="stopwatch-container">
                        <div id="stopwatchDisplay" class="stopwatch-display">00:00:00.000</div>
                        <div class="stopwatch-controls">
                            <button class="start" onclick="startStopwatch()">Iniciar</button>
                            <button class="pause" onclick="pauseStopwatch()">Pausar</button>
                            <button class="reset" onclick="resetStopwatch()">Resetar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="converter">
                 <div class="tab-buttons" style="margin-bottom: 20px;">
                    <button class="active" onclick="showConverterSubTab('lengthConverter')">Comprimento</button>
                    <button onclick="showConverterSubTab('massConverter')">Massa</button>
                    <button onclick="showConverterSubTab('tempConverter')">Temperatura</button>
                    <button onclick="showConverterSubTab('currencyConverter')">Moeda</button>
                </div>
                <div id="lengthConverter" class="converter-container active">
                    <h3>Conversor de Comprimento</h3>
                    <div class="converter-form">
                        <div class="converter-row">
                            <input type="number" id="lengthInput" oninput="convertLength()">
                            <select id="fromLengthUnit" onchange="convertLength()">
                                <option value="m">Metros (m)</option>
                                <option value="km">Quilómetros (km)</option>
                                <option value="cm">Centímetros (cm)</option>
                                <option value="mm">Milímetros (mm)</option>
                                <option value="mi">Milhas (mi)</option>
                                <option value="yd">Jardas (yd)</option>
                                <option value="ft">Pés (ft)</option>
                                <option value="in">Polegadas (in)</option>
                            </select>
                        </div>
                        <i class="fas fa-exchange-alt"></i>
                        <div class="converter-row">
                            <input type="text" id="lengthOutput" readonly>
                             <select id="toLengthUnit" onchange="convertLength()">
                                <option value="km">Quilómetros (km)</option>
                                <option value="m">Metros (m)</option>
                                <option value="cm">Centímetros (cm)</option>
                                <option value="mm">Milímetros (mm)</option>
                                <option value="mi">Milhas (mi)</option>
                                <option value="yd">Jardas (yd)</option>
                                <option value="ft">Pés (ft)</option>
                                <option value="in">Polegadas (in)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="massConverter" class="converter-container" style="display: none;">
                    <h3>Conversor de Massa</h3>
                    <div class="converter-form">
                        <div class="converter-row">
                            <input type="number" id="massInput" oninput="convertMass()">
                            <select id="fromMassUnit" onchange="convertMass()">
                                <option value="g">Gramas (g)</option>
                                <option value="kg">Quilogramas (kg)</option>
                                <option value="mg">Miligramas (mg)</option>
                                <option value="t">Toneladas (t)</option>
                                <option value="lb">Libras (lb)</option>
                                <option value="oz">Onças (oz)</option>
                            </select>
                        </div>
                        <i class="fas fa-exchange-alt"></i>
                        <div class="converter-row">
                            <input type="text" id="massOutput" readonly>
                             <select id="toMassUnit" onchange="convertMass()">
                                <option value="kg">Quilogramas (kg)</option>
                                <option value="g">Gramas (g)</option>
                                <option value="mg">Miligramas (mg)</option>
                                <option value="t">Toneladas (t)</option>
                                <option value="lb">Libras (lb)</option>
                                <option value="oz">Onças (oz)</option>
                            </select>
                        </div>
                    </div>
                </div>
                 <div id="tempConverter" class="converter-container" style="display: none;">
                    <h3>Conversor de Temperatura</h3>
                    <div class="converter-form">
                        <div class="converter-row">
                            <input type="number" id="tempInput" oninput="convertTemp()">
                            <select id="fromTempUnit" onchange="convertTemp()">
                                <option value="C">Celsius (°C)</option>
                                <option value="F">Fahrenheit (°F)</option>
                                <option value="K">Kelvin (K)</option>
                            </select>
                        </div>
                        <i class="fas fa-exchange-alt"></i>
                        <div class="converter-row">
                            <input type="text" id="tempOutput" readonly>
                             <select id="toTempUnit" onchange="convertTemp()">
                                <option value="F">Fahrenheit (°F)</option>
                                <option value="C">Celsius (°C)</option>
                                <option value="K">Kelvin (K)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="currencyConverter" class="converter-container" style="display: none;">
                    <h3>Conversor de Moeda</h3>
                     <div class="converter-form">
                        <div class="converter-row">
                            <input type="number" id="currencyInput" oninput="convertCurrency()">
                            <select id="fromCurrency" onchange="convertCurrency()"></select>
                        </div>
                         <i class="fas fa-exchange-alt"></i>
                        <div class="converter-row">
                           <input type="text" id="currencyOutput" readonly>
                           <select id="toCurrency" onchange="convertCurrency()"></select>
                        </div>
                    </div>
                    <div class="currency-manager">
                        <h4>Gerir Taxas de Câmbio (Base: EUR)</h4>
                        <div id="currencyRatesList"></div>
                        <div class="converter-row" style="margin-top: 10px;">
                           <input type="text" id="newCurrencyCode" placeholder="Código (ex: USD)">
                           <input type="number" id="newCurrencyRate" placeholder="Taxa para 1 EUR">
                           <button onclick="addOrUpdateCurrencyRate()">Adicionar/Atualizar</button>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- Modal para mensagens (mantido) -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p id="modal-message"></p>
        </div>
    </div>

    <!-- Modal para os detalhes das tarefas (mantido) -->
    <div id="taskDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('taskDetailsModal')">&times;</span>
            <div id="taskDetailsContent"></div>
        </div>
    </div>
<!-- Modal para seleção do meio de transporte -->
<div id="transportModeModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('transportModeModal')">&times;</span>
        <h3>Escolha o meio de transporte</h3>
        <div class="transport-options" style="margin-top: 20px;">
            <button onclick="initiateNavigation('driving')"><i class="fas fa-car"></i> Carro</button>
            <button onclick="initiateNavigation('motorcycle')"><i class="fas fa-motorcycle"></i> Moto</button>
            <button onclick="initiateNavigation('cycling')"><i class="fas fa-bicycle"></i> Bicicleta</button>
            <button onclick="initiateNavigation('walking')"><i class="fas fa-walking"></i> A Pé</button>
        </div>
    </div>
</div>

<!-- Novo Modal para Editar Despesa -->
<div id="editExpenseModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('editExpenseModal')">&times;</span>
        <h3>Editar Despesa</h3>
        <form id="editExpenseForm" class="expense-edit-form">
            <input type="hidden" id="editExpenseId">
            <label for="editExpenseAmount">Valor (€):</label>
            <input type="number" id="editExpenseAmount" step="0.01" required>
            <label for="editExpenseDescription">Descrição:</label>
            <input type="text" id="editExpenseDescription" required>
            <label for="editExpenseCategory">Categoria:</label>
            <select id="editExpenseCategory" required>
                <!-- Categorias serão carregadas aqui -->
            </select>
            <label for="editExpenseDate">Data:</label>
            <input type="date" id="editExpenseDate" required>
            <button type="button" onclick="saveEditedExpense()">Guardar Alterações</button>
        </form>
    </div>
</div>


    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    
    <!-- Seu script principal aqui -->
    <script>
        // Configuração do OneSignal (mantida)
        window.OneSignal = window.OneSignal || [];
        OneSignal.push(function() {
            OneSignal.init({
                appId: "09cf47e1-545a-4a0b-9873-f09cc9a71707",
                safari_web_id: "SEU_SAFARI_WEB_ID",
                serviceWorkerUpdaterPath: 'OneSignalSDKUpdateWorker.js',
                serviceWorkerPath: 'OneSignalSDKWorker.js',
            });
            console.log('OneSignal SDK inicializado.');
        });

// =======================================================================
// === Funções JavaScript Atualizadas e Corrigidas (v26)
// =======================================================================

// Variáveis globais
window.appData = null;
let map = null;
let userMarker = null;
let searchMarker = null; // Marcador para o resultado da pesquisa
let navigationActive = false;
let currentRoute = null; // Armazena os dados da rota do OSRM
let routeControl = null; // Armazena a camada da linha da rota (Polyline)
let watchId = null;
let userLocation = null;
let destinationLocation = null;
let destinationName = '';
let routeInstructions = [];
let currentInstructionIndex = 0;
let currentLocationMethod = 'unknown';
let currentCalendarMonth = new Date().getMonth();
let currentCalendarYear = new Date().getFullYear();
let selectedPoisForRoute = JSON.parse(localStorage.getItem('selectedPoisForRoute')) || [];
let notes = [];
let noteToEditId = null; // Variável para armazenar o ID da nota em edição
let expenseChart = null;
const synth = window.speechSynthesis; // API de Síntese de Fala

// --- Funções do Modal ---
function showModal(message) {
    const modal = document.getElementById('messageModal');
    const modalMessage = document.getElementById('modal-message');
    modalMessage.innerText = message;
    modal.style.display = 'block';
}

function closeModal(modalId = 'messageModal') {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

// --- Função para criar ícones do mapa ---
function createMapIcon(color) {
    return new L.Icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
}

// --- Funções de Localização ---
async function getCurrentLocationPromise() {
    console.log('Iniciando processo de geolocalização...');
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Geolocation API não suportada'));
            return;
        }

        const options = { enableHighAccuracy: true, timeout: 8000, maximumAge: 300000 };

        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentLocationMethod = 'gps';
                showLocationStatus('gps', 'GPS ativo');
                resolve([position.coords.latitude, position.coords.longitude]);
            },
            (error) => {
                let errorMessage = 'Erro GPS desconhecido';
                switch(error.code) {
                    case error.PERMISSION_DENIED: errorMessage = 'Permissão GPS negada'; break;
                    case error.POSITION_UNAVAILABLE: errorMessage = 'GPS indisponível'; break;
                    case error.TIMEOUT: errorMessage = 'Timeout GPS'; break;
                }
                console.log('GPS falhou:', errorMessage, 'Tentando por rede...');

                const networkOptions = { enableHighAccuracy: false, timeout: 10000, maximumAge: 600000 };
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocationMethod = 'network';
                        showLocationStatus('network', 'Localização por rede');
                        resolve([position.coords.latitude, position.coords.longitude]);
                    },
                    async (netError) => {
                        console.log('Rede falhou:', netError.message, 'Tentando por IP...');
                        try {
                            const ipLocation = await getLocationByIP();
                            currentLocationMethod = 'ip';
                            showLocationStatus('ip', 'Localização por IP');
                            resolve(ipLocation);
                        } catch (ipError) {
                            console.log('IP falhou:', ipError.message);
                            const viseuDefault = [40.6617747743044, -7.91556785877083];
                            currentLocationMethod = 'default';
                            showLocationStatus('default', 'Localização padrão');
                            resolve(viseuDefault); 
                        }
                    },
                    networkOptions
                );
            },
            options
        );
    });
}


async function getLocationByIP() {
    const services = [
        {
            url: 'https://api.ipgeolocation.io/ipgeo?apiKey=at_free',
            parser: (data) => data.latitude && data.longitude ? [parseFloat(data.latitude), parseFloat(data.longitude)] : null
        }
    ];
    for (const service of services) {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            const response = await fetch(service.url, { signal: controller.signal, headers: { 'Accept': 'application/json' } });
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const data = await response.json();
            const coords = service.parser(data);
            if (coords && !isNaN(coords[0]) && !isNaN(coords[1])) {
                return coords;
            }
        } catch (serviceError) {
            console.log(`Serviço ${service.url} falhou:`, serviceError.message);
            continue;
        }
    }
    throw new Error('Todos os serviços de IP falharam');
}

function showLocationStatus(method, text) {
    const status = document.getElementById('locationStatus');
    const statusText = document.getElementById('locationStatusText');
    status.className = `location-status active ${method}`;
    statusText.textContent = text;
    setTimeout(() => {
        status.classList.remove('active');
    }, 5000);
}

async function getUserLocation() {
    try {
        if (!userLocation) {
            showModal('A obter a sua localização...');
        }
        const location = await getCurrentLocationPromise();
        updateUserLocation(location);
        closeModal();
        let methodMessage = '';
        switch(currentLocationMethod) {
            case 'gps': methodMessage = 'Localização GPS obtida com precisão'; break;
            case 'network': methodMessage = 'Localização obtida por rede Wi-Fi'; break;
            case 'ip': methodMessage = 'Localização aproximada obtida por IP'; break;
            case 'default': methodMessage = 'A usar localização padrão de Viseu'; break;
        }
        if (methodMessage && currentLocationMethod !== 'gps') {
            setTimeout(() => {
                showModal(methodMessage);
                setTimeout(closeModal, 3000);
            }, 1000);
        }
        return location;
    } catch (error) {
        console.error('Erro ao obter localização:', error);
        closeModal();
        showModal('Erro ao obter localização. A usar localização padrão de Viseu.');
        setTimeout(closeModal, 4000);
        const viseuDefault = [40.6617747743044, -7.91556785877083];
        updateUserLocation(viseuDefault);
        return viseuDefault;
    }
}

function updateUserLocation(location) {
    userLocation = L.latLng(location); 
    const userIcon = L.divIcon({
        className: 'custom-div-icon',
        html: '<div style="background-color: #007BFF; width: 1.5rem; height: 1.5rem; display: block; border-radius: 50%; border: 2px solid #FFFFFF; box-shadow: 0 0 8px #007BFF;"></div>',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });
    if (userMarker) {
        userMarker.setLatLng(userLocation);
    } else {
        if (map) {
            userMarker = L.marker(userLocation, { icon: userIcon, title: 'userMarker' }).addTo(map);
            userMarker.bindPopup('A tua localização');
        }
    }
    if (navigationActive && map) {
        map.setView(userLocation, map.getZoom() || 17);
        checkOffRoute();
        updateRouteProgress();
    }
    console.log('Localização do usuário atualizada:', userLocation);
}

// --- Funções de Navegação ---
function speak(text) {
    if (synth.speaking) {
        console.error('speechSynthesis.speaking');
        return;
    }
    const cleanText = text.replace(/<[^>]*>?/gm, '');
    const utterance = new SpeechSynthesisUtterance(cleanText);
    utterance.lang = 'pt-PT';
    utterance.onend = () => console.log('Síntese de voz terminada.');
    utterance.onerror = (event) => console.error('Erro na síntese de voz:', event);
    synth.speak(utterance);
}

function getInstructionIcon(step) {
    const type = step.maneuver.type;
    const modifier = step.maneuver.modifier;

    switch (type) {
        case 'depart': return 'fa-play';
        case 'arrive': return 'fa-flag-checkered';
        case 'merge': return 'fa-code-merge';
        case 'fork': return 'fa-code-fork';
        case 'on ramp': return 'fa-arrow-up';
        case 'off ramp': return 'fa-arrow-down';
        case 'roundabout':
        case 'rotary':
            return 'fa-circle-notch';
        case 'turn':
        case 'end of road':
            if (modifier && modifier.includes('uturn')) return 'fa-undo';
            if (modifier && modifier.includes('sharp right')) return 'fa-arrow-turn-up';
            if (modifier && modifier.includes('right')) return 'fa-arrow-right';
            if (modifier && modifier.includes('slight right')) return 'fa-arrow-up-right-from-square';
            if (modifier && modifier.includes('sharp left')) return 'fa-arrow-turn-up fa-flip-horizontal';
            if (modifier && modifier.includes('left')) return 'fa-arrow-left';
            if (modifier && modifier.includes('slight left')) return 'fa-arrow-up-left-from-square';
            return 'fa-arrow-up';
        default: return 'fa-arrow-up';
    }
}

function getInstructionText(step) {
    const type = step.maneuver.type;
    const modifier = step.maneuver.modifier;
    const name = step.name ? ` para <strong>${step.name}</strong>` : '';
    const exit = step.maneuver.exit ? ` na <strong>${step.maneuver.exit}ª saída</strong>` : '';

    switch (type) {
        case 'depart': return `Parta e siga para norte${name}`;
        case 'arrive': return `Chegou ao seu destino${name}`;
        case 'merge': return `Incorpore-se na via${name}`;
        case 'fork':
            return `Na bifurcação, mantenha-se à ${modifier && modifier.includes('left') ? 'esquerda' : 'direita'}${name}`;
        case 'on ramp': return `Tome a rampa de acesso${name}`;
        case 'off ramp': return `Tome a saída${name}`;
        case 'roundabout':
        case 'rotary':
            return `Na rotunda, tome a ${exit}${name}`;
        case 'end of road':
        case 'turn':
            if (modifier && modifier.includes('uturn')) return `Faça inversão de marcha${name}`;
            if (modifier && modifier.includes('sharp right')) return `Vire acentuadamente à direita${name}`;
            if (modifier && modifier.includes('right')) return `Vire à direita${name}`;
            if (modifier && modifier.includes('slight right')) return `Vire ligeiramente à direita${name}`;
            if (modifier && modifier.includes('sharp left')) return `Vire acentuadamente à esquerda${name}`;
            if (modifier && modifier.includes('left')) return `Vire à esquerda${name}`;
            if (modifier && modifier.includes('slight left')) return `Vire ligeiramente à esquerda${name}`;
            return `Siga em frente${name}`;
        default: return `Siga em frente${name}`;
    }
}


async function calculateRoute(start, end, transportMode = 'driving') {
    try {
        const url = `https://router.project-osrm.org/route/v1/${transportMode}/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson&steps=true`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        const data = await response.json();
        if (!data.routes || data.routes.length === 0) throw new Error('Nenhuma rota encontrada');
        
        currentRoute = data.routes[0]; 
        
        routeInstructions = [];
        if (currentRoute.legs && currentRoute.legs[0] && currentRoute.legs[0].steps) {
            currentRoute.legs[0].steps.forEach(step => {
                routeInstructions.push({
                    instruction: getInstructionText(step),
                    distance: step.distance > 1000 ? `${(step.distance / 1000).toFixed(1)} km` : `${Math.round(step.distance)} m`,
                    icon: getInstructionIcon(step),
                    location: step.maneuver.location
                });
            });
        }
        routeInstructions.push({ instruction: 'Chegou ao seu destino', distance: '0m', icon: 'fa-flag-checkered' });
        currentInstructionIndex = 0;
        updateNavigationPanel();
        
        if (routeControl) map.removeLayer(routeControl);
        
        const coordinates = currentRoute.geometry.coordinates.map(coord => [coord[1], coord[0]]);
        routeControl = L.polyline(coordinates, { color: '#2196F3', weight: 6, opacity: 0.8 }).addTo(map);
        
        const bounds = L.latLngBounds(L.latLng(start.lat, start.lng), L.latLng(end.lat, end.lng));
        map.fitBounds(bounds, { padding: [50, 50] });
        
        document.getElementById('navDistance').textContent = `${(currentRoute.distance / 1000).toFixed(1)} km`;
        document.getElementById('navDuration').textContent = `${Math.round(currentRoute.duration / 60)} min`;

        speak(routeInstructions[0].instruction);

    } catch (error) {
        console.error('Erro ao calcular rota:', error);
        throw error;
    }
}

function showTransportModeSelection(destLat, destLng, destName) {
    destinationLocation = L.latLng(destLat, destLng);
    destinationName = destName;
    document.getElementById('transportModeModal').style.display = 'block';
}

async function initiateNavigation(transportMode) {
    closeModal('transportModeModal');

    if (!map) {
        initMap();
        await new Promise(resolve => setTimeout(resolve, 500));
    }

    if (!userLocation) {
        try {
            showModal('A obter a sua localização...');
            const locationArray = await getCurrentLocationPromise();
            userLocation = L.latLng(locationArray[0], locationArray[1]);
            updateUserLocation(userLocation);
            closeModal();
        } catch (error) {
            closeModal();
            showLocationOptions(destinationLocation.lat, destinationLocation.lng, destinationName);
            return;
        }
    }

    if (map && userLocation) map.setView(userLocation, 17);
    
    try {
        showModal('Calculando rota...');
        await calculateRoute(userLocation, destinationLocation, transportMode);
        navigationActive = true;
        document.getElementById('navigationPanel').classList.add('active');
        showTab('mapa');
        document.getElementById('mapa').scrollIntoView({ behavior: 'smooth' });
        closeModal();
        startGPSTracking();
    } catch (error) {
        closeModal();
        showModal('Erro ao calcular a rota. Verifique a sua ligação à internet e tente novamente.');
    }
}


function showLocationOptions(destLat, destLng, destName) {
    const modal = document.getElementById('messageModal');
    const modalContent = modal.querySelector('.modal-content');
    modalContent.innerHTML = `
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h3 style="margin-bottom: 20px;">Como deseja navegar?</h3>
        <p style="margin-bottom: 20px;">Não conseguimos aceder à sua localização GPS.</p>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <button onclick="setManualLocation(${destLat}, ${destLng}, '${destName}')" style="padding: 15px; background: #4facfe; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                <i class="fa-solid fa-map-marker-alt"></i> Definir localização manualmente
            </button>
            <button onclick="openExternalNavigation(${destLat}, ${destLng}, '${destName}')" style="padding: 15px; background: #25D366; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                <i class="fa-solid fa-external-link-alt"></i> Abrir no Google Maps
            </button>
            <button onclick="tryLocationAgain(${destLat}, ${destLng}, '${destName}')" style="padding: 15px; background: #ff9800; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                <i class="fa-solid fa-redo"></i> Tentar localização novamente
            </button>
            <button onclick="showDirections(${destLat}, ${destLng}, '${destName}')" style="padding: 15px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                <i class="fa-solid fa-directions"></i> Ver apenas direções
            </button>
        </div>
    `;
    modal.style.display = 'block';
}

function setManualLocation(destLat, destLng, destName) {
    closeModal();
    showModal('Clique no mapa para definir a sua localização atual');
    showTab('mapa');
    if (!map) initMap();
    if (map.manualLocationListener) map.off('click', map.manualLocationListener);
    map.manualLocationListener = function(e) {
        updateUserLocation([e.latlng.lat, e.latlng.lng]);
        map.off('click', map.manualLocationListener);
        delete map.manualLocationListener;
        closeModal();
        setTimeout(() => { showTransportModeSelection(destLat, destLng, destName); }, 500);
    };
}

function openExternalNavigation(destLat, destLng, destName) {
    closeModal();
    const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}&travelmode=driving`;
    if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        const nativeUrl = `geo:${destLat},${destLng}?q=${destLat},${destLng}(${encodeURIComponent(destName)})`;
        window.location.href = nativeUrl;
        setTimeout(() => { window.open(googleMapsUrl, '_blank'); }, 2000);
    } else {
        window.open(googleMapsUrl, '_blank');
    }
}

async function tryLocationAgain(destLat, destLng, destName) {
    closeModal();
    userLocation = null;
    showTransportModeSelection(destLat, destLng, destName);
}

function showDirections(destLat, destLng, destName) {
    closeModal();
    const viseuCenter = L.latLng(40.6617747743044, -7.91556785877083);
    userLocation = viseuCenter;
    updateUserLocation(viseuCenter);
    if (!map) initMap();
    calculateRoute(viseuCenter, L.latLng(destLat, destLng)).then(() => {
        navigationActive = true;
        document.getElementById('navigationPanel').classList.add('active');
        showTab('mapa');
        showModal('Rota calculada! Note que sem GPS, a navegação não será atualizada automaticamente.');
        setTimeout(closeModal, 3000);
    }).catch(error => {
        showModal('Erro ao calcular rota: ' + error.message);
    });
}

function updateNavigationPanel() {
    const instructionsEl = document.getElementById('navInstructions');
    instructionsEl.innerHTML = '';
    const numInstructionsToShow = 2;
    for (let i = 0; i < numInstructionsToShow; i++) {
        const index = currentInstructionIndex + i;
        if (index < routeInstructions.length) {
            const instruction = routeInstructions[index];
            const div = document.createElement('div');
            div.className = 'nav-instruction';
            div.style.background = i === 0 ? '#e3f2fd' : 'rgba(255,255,255,0.25)';
            const instructionText = instruction.instruction || "Siga em frente";
            const instructionDistance = instruction.distance || "0m";

            div.innerHTML = `
                <div class="nav-instruction-icon"><i class="fa-solid ${instruction.icon || 'fa-arrow-right'}"></i></div>
                <div class="nav-instruction-text">${instructionText}</div>
                <div class="nav-instruction-distance">${instructionDistance}</div>
            `;
            instructionsEl.appendChild(div);
        }
    }
}

function startGPSTracking() {
    if (watchId !== null) navigator.geolocation.clearWatch(watchId);
    if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const newLocation = [position.coords.latitude, position.coords.longitude];
                updateUserLocation(newLocation);
            },
            (error) => { console.error('Erro de tracking GPS:', error); },
            { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
        );
    } else {
        console.error("Geolocation is not supported by this browser.");
    }
}

async function recalculateRoute() {
    if (userLocation && destinationLocation) {
        showModal('Recalculando a rota...');
        try {
            await calculateRoute(userLocation, destinationLocation);
            if (map && userLocation) map.setView(userLocation, 17);
            closeModal();
            startGPSTracking();
        } catch (error) {
            closeModal();
            showModal('Erro ao recalcular a rota. Verifique a sua ligação à internet.');
        }
    } else {
        console.warn('Localização do utilizador ou destino desconhecidos. Não é possível recalcular a rota.');
    }
}

function stopNavigation() {
    navigationActive = false;
    document.getElementById('navigationPanel').classList.remove('active');
    if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
    if (routeControl) { map.removeLayer(routeControl); routeControl = null; }
    currentInstructionIndex = 0;
    routeInstructions = [];
    currentRoute = null;
    synth.cancel(); 
    console.log('Navegação parada');
}

function checkOffRoute() {
    if (!userLocation || !routeControl) return;

    const userLatLng = userLocation;
    const closestPoint = L.GeometryUtil.closest(map, routeControl, userLatLng);
    const distance = userLatLng.distanceTo(closestPoint);

    if (distance > 50) { 
        console.log("Fora da rota! A recalcular...");
        showModal("Desviou-se da rota. A recalcular...");
        recalculateRoute();
    }
}

function updateRouteProgress() {
    if (!userLocation || !routeControl || !routeInstructions.length) return;

    const nextInstruction = routeInstructions[currentInstructionIndex];
    if (!nextInstruction || !nextInstruction.location) return;

    const nextInstructionPoint = L.latLng(nextInstruction.location[1], nextInstruction.location[0]);
    const distanceToNextInstruction = userLocation.distanceTo(nextInstructionPoint);

    if (distanceToNextInstruction < 20) { 
        currentInstructionIndex++;
        if (currentInstructionIndex < routeInstructions.length) {
            updateNavigationPanel();
            speak(routeInstructions[currentInstructionIndex].instruction);
        } else {
            stopNavigation(); 
        }
    }

    const routeCoords = currentRoute.geometry.coordinates.map(coord => L.latLng(coord[1], coord[0]));
    const userPointOnRoute = L.GeometryUtil.closest(map, routeCoords, userLocation);
    const closestIndex = L.GeometryUtil.closestLayer(map, routeCoords.map((c, i) => ({latlng: c, i: i})), userPointOnRoute).layer.i;

    const remainingCoords = routeCoords.slice(closestIndex);
    remainingCoords.unshift(userLocation); 
    routeControl.setLatLngs(remainingCoords);
}

// --- Funções da Aba PDF ---
function renderPdfButtons() {
    const pdfNav = document.getElementById('pdf-nav');
    pdfNav.innerHTML = '';
    if (!window.appData || !window.appData.pdfRotas) return;
    window.appData.pdfRotas.forEach(pdf => {
        const button = document.createElement('button');
        button.id = `btnPdf-${pdf.id}`;
        button.textContent = pdf.nome;
        button.onclick = () => {
            showPdf(pdf.id);
            document.querySelectorAll('#pdf-nav button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        };
        pdfNav.appendChild(button);
    });
    if (window.appData.pdfRotas.length > 0) {
        showPdf(window.appData.pdfRotas[0].id);
        const firstButton = document.getElementById(`btnPdf-${window.appData.pdfRotas[0].id}`);
        if (firstButton) {
            firstButton.classList.add('active');
        }
    }
}

function showPdf(pdfId) {
    const img = document.getElementById('pdf-image');
    const pdfs = window.appData.pdfRotas;
    const selectedPdf = pdfs.find(pdf => pdf.id === pdfId);
    if (selectedPdf) {
        img.src = selectedPdf.pdfUrl;
    } else {
        img.src = '';
        img.alt = 'Imagem não encontrada.';
    }
}

// --- Funções da Aba Lembretes ---
let reminders = JSON.parse(localStorage.getItem('busReminders')) || [];

function renderReminders() {
    const list = document.getElementById('reminderList');
    list.innerHTML = '';
    if (reminders.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #666;">Não há lembretes definidos.</p>';
        return;
    }
    reminders.forEach((r, index) => {
        const item = document.createElement('li');
        item.className = 'reminder-item';
        let typeText = r.type === 'ics' ? 'ICS' : 'Notificação';

        item.innerHTML = `
            <div class="reminder-details">
                <h4>Lembrete (${typeText}) para a rota: ${r.routeName || r.name || r.nome}</h4>
                <p>Horário: ${r.time} - Ativado ${r.minutesBefore || 10} minutos antes</p>
            </div>
            <button class="reminder-remove" onclick="removeReminder(${index})">&times;</button>
        `;
        list.appendChild(item);
    });
}

function checkIfReminderExists(name, time) {
    return reminders.some(r => (r.routeName === name || r.name === name || r.nome === name) && r.time === time);
}

async function addReminder(itemData) {
    const name = itemData.routeName || itemData.name || itemData.nome;
    const time = itemData.time;
    const date = itemData.date;

    if (checkIfReminderExists(name, time)) {
        showModal('Já existe um lembrete ou um ficheiro ICS para este horário/tarefa. Por favor, remova o existente para adicionar um novo.');
        return;
    }

    try {
        const userId = await OneSignal.getUserId();
        if (userId) {
            const reminderPayload = {
                playerId: userId,
                name: name,
                time: time,
                date: date,
                minutesBefore: 10
            };

            const response = await fetch('https://schedulenotification-lpmrppc7cq-uc.a.run.app', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reminderPayload)
            });
            const data = await response.json();

            if (data.success) {
                reminders.push({ ...itemData, type: 'onesignal', name: name });
                localStorage.setItem('busReminders', JSON.stringify(reminders));
                showModal('Lembrete agendado com sucesso!');
                renderReminders();
            } else {
                throw new Error(data.message || 'Erro de servidor desconhecido');
            }
        } else {
            reminders.push({ ...itemData, type: 'manual', name: name });
            localStorage.setItem('busReminders', JSON.stringify(reminders));
            showModal('Lembrete adicionado localmente. Ative as notificações para lembretes automáticos.');
            renderReminders();
            OneSignal.showNativePrompt();
        }
    } catch (error) {
        console.error('Erro ao agendar lembrete:', error);
        reminders.push({ ...itemData, type: 'manual', name: name });
        localStorage.setItem('busReminders', JSON.stringify(reminders));
        showModal('Erro de comunicação com o servidor. Lembrete adicionado localmente.');
        renderReminders();
    }
}


function removeReminder(index) {
    reminders.splice(index, 1);
    localStorage.setItem('busReminders', JSON.stringify(reminders));
    showModal('Lembrete removido. Se adicionou este lembrete ao seu calendário, lembre-se de o remover manualmente.');
    renderReminders();
}

function cleanupExpiredReminders() {
    const now = new Date();
    const nowString = now.toTimeString().split(' ')[0].substring(0, 5); 
    reminders = reminders.filter(r => {
        if (r.routeName) { 
            return r.time > nowString;
        }
        if (r.date && r.time) { 
            const taskDateTime = new Date(`${r.date}T${r.time}`);
            return taskDateTime > now;
        }
        return false; 
    });
    localStorage.setItem('busReminders', JSON.stringify(reminders));
}

function generateICS(itemData, isTask = false) {
    const name = itemData.routeName || itemData.name || itemData.nome;
    const time = itemData.time;
    const date = itemData.date;
    const description = itemData.description || itemData.descricao || '';

    if (checkIfReminderExists(name, time)) {
        showModal('Já existe um lembrete ou um ficheiro ICS para este horário/tarefa. Por favor, remova o existente para criar um novo.');
        return;
    }

    reminders.push({ ...itemData, type: 'ics', name: name });
    localStorage.setItem('busReminders', JSON.stringify(reminders));
    renderReminders();
    showModal('Ficheiro ICS gerado. Por favor, importe-o para o seu calendário.');

    const now = new Date();
    const [hour, minute] = time.split(':').map(Number);
    let eventDate;

    if (date) {
        eventDate = new Date(`${date}T${time}`);
    } else {
        eventDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute);
        if (eventDate < now) {
            eventDate.setDate(eventDate.getDate() + 1);
        }
    }

    const formatICSDate = (d) => d.toISOString().replace(/[-:]|\.\d{3}/g, '');

    const start = formatICSDate(eventDate);
    const end = formatICSDate(new Date(eventDate.getTime() + 30 * 60000));

    let alarms = '';
    if (isTask) {
        const trigger1Day = new Date(eventDate.getTime() - (24 * 60 * 60 * 1000));
        alarms += `
BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:Lembrete: ${itemData.routeName ? `Autocarro - Rota ${name}` : `Tarefa - ${name}`} (1 dia antes)
TRIGGER;VALUE=DATE-TIME:${formatICSDate(trigger1Day)}
END:VALARM`;

        alarms += `
BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:Lembrete: ${itemData.routeName ? `Autocarro - Rota ${name}` : `Tarefa - ${name}`} (30 minutos antes)
TRIGGER:-PT30M
END:VALARM`;
    } else {
        alarms += `
BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:Lembrete: ${itemData.routeName ? `Autocarro - Rota ${name}` : `Tarefa - ${name}`}
TRIGGER:-PT10M
END:VALARM`;
    }

    const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//gemini-app//NONSGML v1.0//EN
BEGIN:VEVENT
UID:${Date.now()}-${Math.random()}
DTSTAMP:${start}
DTSTART:${start}
DTEND:${end}
SUMMARY:${itemData.routeName ? `Autocarro - Rota ${name}` : `Tarefa - ${name}`}
DESCRIPTION:${itemData.routeName ? `O teu autocarro para a rota ${name} parte às ${time}.` : description || `Lembrete para a tarefa: ${name}.`}
${alarms}
END:VEVENT
END:VCALENDAR`;

    const blob = new Blob([icsContent], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${name.replace(/ /g, '_')}_${date ? date + '_' : ''}${time}.ics`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function shareWhatsApp(itemData) {
    const name = itemData.routeName || itemData.name || itemData.nome;
    const time = itemData.time;
    const date = itemData.date;
    let message;

    if (itemData.routeName) {
        message = `Olá! O próximo autocarro para a rota ${name} é às ${time}.`;
    } else {
        message = `Lembrete de tarefa: ${name} em ${date} ${time ? ` às ${time}` : ''}.`;
    }

    const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}


// --- Funções de Gestão de Abas ---
function showTab(tabId) {
    document.querySelectorAll('.tab-content > div').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-buttons button').forEach(button => button.classList.remove('active'));

    document.getElementById(tabId).classList.add('active');
    
    let buttonIdMap = {
        'horarios': 'btnHorarios', 'toDoList': 'btnToDoList', 'notes': 'btnNotas',
        'weather': 'btnMeteorologia', 'expenses': 'btnDespesas', 'horariosPdf': 'btnHorariosPdf',
        'lembretes': 'btnLembretes', 'pontosDeInteresse': 'btnPontosDeInteresse', 'mapa': 'btnMapa',
        'calculator': 'btnCalculadora', 'timer': 'btnTemporizador', 'converter': 'btnConversor',
        'pdfReader': 'btnPdfReader'
    };
    const buttonElement = document.getElementById(buttonIdMap[tabId]);
    if (buttonElement) {
        buttonElement.classList.add('active');
    }

    if (tabId === 'mapa') {
        if (map === null) {
            initMap();
        } else {
            setTimeout(() => map.invalidateSize(), 100);
        }
        getUserLocation();
    } else if (tabId === 'lembretes') {
        renderReminders();
    } else if (tabId === 'pontosDeInteresse') {
        renderPontosDeInteresse();
    } else if (tabId === 'toDoList') {
        showToDoSubTab('taskFormTab');
    } else if (tabId === 'notes') {
        renderNotes();
    } else if (tabId === 'weather') {
        getWeatherByCurrentLocation();
    } else if (tabId === 'expenses') {
        showExpenseSubTab('addExpenseTab');
    } else if (tabId === 'converter') {
        showConverterSubTab('lengthConverter');
        initCurrencyConverter();
    }
}

function showToDoSubTab(subTabId) {
    document.querySelectorAll('.to-do-sub-content > div').forEach(subTab => subTab.classList.remove('active'));
    document.querySelectorAll('#toDoList .tab-buttons button').forEach(button => button.classList.remove('active'));

    document.getElementById(subTabId).classList.add('active');
    
    let buttonId = subTabId;
    if (subTabId.endsWith('Tab')) {
        buttonId = subTabId.slice(0, -3); 
    }
    document.getElementById(`btn${buttonId.charAt(0).toUpperCase() + buttonId.slice(1)}Tab`).classList.add('active');


    if (subTabId === 'calendarTab') {
        renderCalendar();
    } else if (subTabId === 'taskListTab') {
        renderTaskList();
    }
}


// --- Funções de Inicialização do Mapa ---
function initMap() {
    if (map) return; 
    const viseu = [40.6617747743044, -7.91556785877083];
    map = L.map('map').setView(viseu, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    if (window.appData && window.appData.paragens) {
        window.appData.paragens.forEach(paragem => {
            const color = paragem.tipo === 'IDA' ? 'green' : 'red';
            const icon = createMapIcon(color);
            L.marker([paragem.lat, paragem.lng], { icon: icon })
                .addTo(map)
                .bindPopup(`
                    <div>
                        <b>Paragem:</b> ${paragem.nome || 'Nome Indisponível'}<br>
                        <button onclick="showTransportModeSelection(${paragem.lat}, ${paragem.lng}, '${paragem.nome.replace(/'/g, "\\'")}')"
                                style="margin-top: 8px; padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fa-solid fa-route"></i> Navegar
                        </button>
                    </div>
                `);
        });
    }

    if (window.appData && window.appData.pontosDeInteresse) {
        window.appData.pontosDeInteresse.forEach(poi => {
            const icon = createMapIcon('yellow');
            L.marker([poi.lat, poi.lng], { icon: icon })
                .addTo(map)
                .bindPopup(`
                    <div>
                        <b>${poi.nome || 'Nome Indisponível'}</b><br>${poi.descricao || 'Descrição Indisponível'}<br>
                        <button onclick="showTransportModeSelection(${poi.lat}, ${poi.lng}, '${poi.nome.replace(/'/g, "\\'")}')"
                                style="margin-top: 8px; padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fa-solid fa-route"></i> Navegar
                        </button>
                    </div>
                `);
        });
    }
}

async function searchMapLocation() {
    const query = document.getElementById('search-input').value;
    if (!query) {
        showModal("Por favor, insira um local para pesquisar.");
        return;
    }
    showModal(`A pesquisar por "${query}"...`);
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
        const data = await response.json();
        closeModal();
        if (data && data.length > 0) {
            const { lat, lon, display_name } = data[0];
            const latLng = [parseFloat(lat), parseFloat(lon)];
            if(map) {
                if (searchMarker) {
                    map.removeLayer(searchMarker);
                }
                map.setView(latLng, 15);
                searchMarker = L.marker(latLng).addTo(map)
                    .bindPopup(`
                        <b>${display_name}</b><br>
                        <button onclick="showTransportModeSelection(${lat}, ${lon}, '${display_name.replace(/'/g, "\\'")}')"
                                style="margin-top: 8px; padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fa-solid fa-route"></i> Navegar
                        </button>
                    `)
                    .openPopup();
            }
        } else {
            showModal("Local não encontrado.");
        }
    } catch (error) {
        closeModal();
        showModal("Erro ao pesquisar o local. Verifique a sua ligação.");
        console.error("Erro na pesquisa do mapa:", error);
    }
}

function focusOnMapPoint(lat, lng, poiName) {
    showTab('mapa');
    if (!map) initMap();
    setTimeout(() => {
        map.setView([lat, lng], 17);
        map.eachLayer(function (layer) {
            if (layer instanceof L.Marker && layer.getLatLng().equals([lat, lng])) {
                layer.openPopup();
            }
        });
    }, 100);
}

// --- Funções de Pontos de Interesse ---
function togglePoiSelection(poiDataEncoded) {
    const poi = JSON.parse(decodeURIComponent(poiDataEncoded));
    const index = selectedPoisForRoute.findIndex(p => p.id === poi.id);

    if (index === -1) {
        selectedPoisForRoute.push(poi);
    } else {
        selectedPoisForRoute.splice(index, 1);
    }
    localStorage.setItem('selectedPoisForRoute', JSON.stringify(selectedPoisForRoute));
    renderPontosDeInteresse();
}


function renderPontosDeInteresse() {
    const poiList = document.getElementById('poiList');
    poiList.innerHTML = '';

    const filterValue = document.getElementById('poiFilterSelect').value;
    let filteredPois = [];

    if (!window.appData || !window.appData.pontosDeInteresse) {
        poiList.innerHTML = '<p style="text-align: center; color: #666;">Não foram encontrados pontos de interesse.</p>';
        return;
    }

    const allPois = window.appData.pontosDeInteresse;
    const currentSearchQuery = document.getElementById('poiSearchInput').value.toLowerCase();

    let searchedPois = allPois.filter(poi => {
        return (poi.nome && poi.nome.toLowerCase().includes(currentSearchQuery)) ||
               (poi.descricao && poi.descricao.toLowerCase().includes(currentSearchQuery));
    });

    if (filterValue === 'selected') {
        filteredPois = searchedPois.filter(poi => selectedPoisForRoute.some(selected => selected.id === poi.id));
    } else if (filterValue === 'unselected') {
        filteredPois = searchedPois.filter(poi => !selectedPoisForRoute.some(selected => selected.id === poi.id));
    } else { 
        filteredPois = searchedPois;
    }

    if (filteredPois.length === 0) {
        poiList.innerHTML = '<p style="text-align: center; color: #666;">Não foram encontrados pontos de interesse com os filtros aplicados.</p>';
        return;
    }

    filteredPois.forEach(poi => {
        const item = document.createElement('li');
        item.className = 'poi-item';
        item.id = `poi-list-item-${poi.id}`;

        const isSelected = selectedPoisForRoute.some(selected => selected.id === poi.id);

        let linkButton = '';
        if (poi.link && poi.link.trim() !== '') {
            linkButton = `<button class="btn-link" onclick="window.open('${poi.link}', '_blank')" title="Abrir link"><i class="fa-solid fa-link"></i></button>`;
        }

        item.innerHTML = `
            <div class="poi-details">
                 <h4>${poi.nome || 'Nome Indisponível'}</h4>
                <p>${poi.descricao || 'Descrição Indisponível'}</p>
            </div>
            <div class="action-buttons">
                <input type="checkbox" class="poi-checkbox" data-poi-id="${poi.id}" onchange="togglePoiSelection('${encodeURIComponent(JSON.stringify(poi))}')" ${isSelected ? 'checked' : ''}>
                ${linkButton}
                <button class="btn-map-pin" onclick="focusOnMapPoint(${poi.lat}, ${poi.lng}, '${poi.nome.replace(/'/g, "\\'")}')" title="Ver no mapa">
                    <i class="fa-solid fa-map-location-dot"></i>
                </button>
                <button class="btn-navigate" onclick="showTransportModeSelection(${poi.lat}, ${poi.lng}, '${poi.nome.replace(/'/g, "\\'")}')" title="Navegar até aqui">
                    <i class="fa-solid fa-route"></i>
                </button>
            </div>
        `;
        poiList.appendChild(item);
    });
}

async function createRouteFromSelectedPois() {
    if (selectedPoisForRoute.length < 1) {
        showModal('Selecione pelo menos 1 ponto de interesse para criar uma rota.');
        return;
    }

    showTab('mapa');
    if (!map) {
        initMap();
        await new Promise(resolve => setTimeout(resolve, 500));
    }

    if (routeControl) {
        map.removeLayer(routeControl);
        routeControl = null;
    }
    
    let waypoints = [];
    if (userLocation) {
        waypoints.push(userLocation);
    } else {
        const locationArray = await getCurrentLocationPromise();
        userLocation = L.latLng(locationArray[0], locationArray[1]);
        waypoints.push(userLocation);
    }

    selectedPoisForRoute.forEach(poi => {
        waypoints.push(L.latLng(poi.lat, poi.lng));
    });

    if (waypoints.length < 2) {
        showModal('São necessários pelo menos 2 pontos para criar uma rota.');
        return;
    }

    showModal('Calculando rota com múltiplos pontos...');

    const waypointsString = waypoints.map(wp => `${wp.lng},${wp.lat}`).join(';');
    destinationLocation = waypoints[waypoints.length - 1]; 

    try {
        const url = `https://router.project-osrm.org/route/v1/driving/${waypointsString}?overview=full&geometries=geojson&steps=true`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        const data = await response.json();
        if (!data.routes || data.routes.length === 0) throw new Error('Nenhuma rota encontrada');

        currentRoute = data.routes[0];
        routeInstructions = [];
        if (currentRoute.legs) {
            currentRoute.legs.forEach(leg => {
                leg.steps.forEach(step => {
                    routeInstructions.push({
                        instruction: getInstructionText(step),
                        distance: step.distance > 1000 ? `${(step.distance / 1000).toFixed(1)} km` : `${Math.round(step.distance)} m`,
                        icon: getInstructionIcon(step),
                        location: step.maneuver.location
                    });
                });
            });
        }
        routeInstructions.push({ instruction: 'Chegou ao seu destino final', distance: '0m', icon: 'fa-flag-checkered' });
        
        currentInstructionIndex = 0;
        updateNavigationPanel();
        
        const coordinates = currentRoute.geometry.coordinates.map(coord => [coord[1], coord[0]]);
        routeControl = L.polyline(coordinates, { color: '#2196F3', weight: 6, opacity: 0.8 }).addTo(map);
        
        map.fitBounds(routeControl.getBounds(), { padding: [50, 50] });
        
        document.getElementById('navDistance').textContent = `${(currentRoute.distance / 1000).toFixed(1)} km`;
        document.getElementById('navDuration').textContent = `${Math.round(currentRoute.duration / 60)} min`;

        navigationActive = true;
        document.getElementById('navigationPanel').classList.add('active');
        closeModal();
        startGPSTracking();
        speak(routeInstructions[0].instruction);

    } catch (error) {
        closeModal();
        console.error('Erro de roteamento com múltiplos pontos:', error);
        showModal('Erro ao calcular a rota com múltiplos pontos. Por favor, tente novamente.');
    }
}


// --- Funções da To-Do List ---
function updateTaskColorSelect() {
    const prioritySelect = document.getElementById('taskPrioritySelect');
    const colorSelect = document.getElementById('taskColorSelect');
    const selectedPriority = prioritySelect.value;

    let suggestedColor = '';
    switch (selectedPriority) {
        case 'prioritaria': suggestedColor = '#f44336'; break; 
        case 'urgente': suggestedColor = '#ff9800'; break; 
        case 'nao-urgente': suggestedColor = '#4caf50'; break; 
        case 'social': suggestedColor = '#2196f3'; break; 
        case 'viagem': suggestedColor = '#FFD600'; break; 
    }
    colorSelect.value = suggestedColor;

    colorSelect.style.backgroundColor = suggestedColor;
    colorSelect.style.color = getContrastColor(suggestedColor);
}

function getContrastColor(hexcolor) {
    if (!hexcolor || !hexcolor.startsWith('#') || hexcolor.length !== 7) {
        return '#000000'; 
    }

    const r = parseInt(hexcolor.substr(1, 2), 16);
    const g = parseInt(hexcolor.substr(3, 2), 16);
    const b = parseInt(hexcolor.substr(5, 2), 16);
    const y = ((r * 299) + (g * 587) + (b * 114)) / 1000;
    return (y >= 128) ? '#000000' : '#ffffff';
}


function addTask() {
    const taskName = document.getElementById('taskNameInput').value.trim();
    const taskDate = document.getElementById('taskDateInput').value;
    const taskTime = document.getElementById('taskTimeInput').value;
    const taskPriority = document.getElementById('taskPrioritySelect').value;
    const taskColor = document.getElementById('taskColorSelect').value;
    const taskIsTravel = document.getElementById('taskIsTravel').checked;
    const taskLat = document.getElementById('taskLatInput').value;
    const taskLng = document.getElementById('taskLngInput').value;
    const taskDescription = document.getElementById('taskDescriptionInput').value;

    if (!taskName || !taskDate) {
        showModal('Por favor, preencha o nome e a data da tarefa.');
        return;
    }

    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    const newTask = {
        id: 'task_' + Date.now(),
        name: taskName,
        date: taskDate,
        time: taskTime,
        priority: taskPriority,
        color: taskColor,
        isTravel: taskIsTravel,
        lat: taskIsTravel ? taskLat : '',
        lng: taskIsTravel ? taskLng : '',
        description: taskDescription,
        isCompleted: false
    };

    tasks.push(newTask);
    localStorage.setItem('tasks', JSON.stringify(tasks));
    showModal('Tarefa adicionada com sucesso!');
    document.getElementById('taskForm').reset();
    updateTaskColorSelect(); 
    renderTaskList();
    renderCalendar();
    showToDoSubTab('taskListTab'); 
}

function renderTaskList() {
    const taskList = document.getElementById('taskList');
    const sortBy = document.getElementById('taskSortSelect').value;
    taskList.innerHTML = '';
    
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];

    if (tasks.length === 0) {
        taskList.innerHTML = '<p class="no-items">Nenhuma tarefa agendada.</p>';
        return;
    }

    if (sortBy === 'priority') {
        const priorityMap = { 'prioritaria': 3, 'urgente': 2, 'nao-urgente': 1, 'social': 0, 'viagem': 0 };
        tasks.sort((a, b) => priorityMap[b.priority] - priorityMap[a.priority]);
    } else if (sortBy === 'chronological') {
        tasks.sort((a, b) => new Date(`${a.date}T${a.time || '00:00'}`) - new Date(`${b.date}T${b.time || '00:00'}`));
    }

    tasks.forEach(task => {
        const taskItem = document.createElement('li');
        taskItem.className = `task-item task-priority-${task.priority}`;
        if (task.isCompleted) {
            taskItem.classList.add('completed');
        }
        
        taskItem.innerHTML = `
            <div class="task-details" style="border-left: 5px solid ${task.color};" onclick="showTaskDetails('${task.id}')">
                <h4>${task.name}</h4>
                <p>${task.date} ${task.time ? `às ${task.time}` : ''}</p>
                <p>${task.description || ''}</p>
            </div>
            <div class="task-actions">
                <button class="btn-task-complete" onclick="toggleTaskCompletion('${task.id}')" title="${task.isCompleted ? 'Marcar como incompleto' : 'Marcar como completo'}">
                    <i class="fas fa-check"></i>
                </button>
                <button class="btn-task-reminder" onclick="addReminder({id: '${task.id}', name: '${task.name}', date: '${task.date}', time: '${task.time}'})" title="Adicionar lembrete">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="btn-task-calendar" onclick="generateICS({id: '${task.id}', name: '${task.name}', date: '${task.date}', time: '${task.time}', description: '${task.description}'}, true)" title="Gerar ICS">
                    <i class="fas fa-calendar-plus"></i>
                </button>
                <button class="btn-task-whatsapp" onclick="shareWhatsApp({id: '${task.id}', name: '${task.name}', date: '${task.date}', time: '${task.time}'})" title="Partilhar no WhatsApp">
                    <i class="fab fa-whatsapp"></i>
                </button>
                ${task.isTravel && task.lat && task.lng ? `<button class="btn-task-navigate" onclick="navigateToTask('${task.id}')" title="Navegar para a viagem"><i class="fas fa-route"></i></button>` : ''}
                <button class="btn-task-delete" onclick="deleteTask('${task.id}')" title="Eliminar tarefa">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        `;
        taskList.appendChild(taskItem);
    });
}

function renderCalendar() {
    const calendarBody = document.getElementById('calendarBody');
    const monthYearDisplay = document.getElementById('currentMonthYear');
    
    window.nextMonth = () => {
        currentCalendarMonth++;
        if (currentCalendarMonth > 11) {
            currentCalendarMonth = 0;
            currentCalendarYear++;
        }
        renderCalendarMonth(currentCalendarMonth, currentCalendarYear);
    };

    window.prevMonth = () => {
        currentCalendarMonth--;
        if (currentCalendarMonth < 0) {
            currentCalendarMonth = 11;
            currentCalendarYear--;
        }
        renderCalendarMonth(currentCalendarMonth, currentCalendarYear);
    };

    function renderCalendarMonth(month, year) {
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        
        monthYearDisplay.textContent = new Date(year, month).toLocaleString('pt-PT', { month: 'long', year: 'numeric' });
        calendarBody.innerHTML = '';
        
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];

        const startDayOffset = (firstDayOfMonth === 0) ? 6 : (firstDayOfMonth - 1);
        for (let i = 0; i < startDayOffset; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day empty';
            calendarBody.appendChild(emptyCell);
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            if (date.toDateString() === today.toDateString()) {
                dayCell.classList.add('today');
            }
            
            dayCell.innerHTML = `<span>${day}</span>`;
            
            const dailyTasks = tasks.filter(task => {
                const taskDate = new Date(task.date);
                return taskDate.getFullYear() === year && taskDate.getMonth() === month && taskDate.getDate() === day;
            });
            
            if (dailyTasks.length > 0) {
                dailyTasks.forEach(task => {
                    const taskEvent = document.createElement('div');
                    taskEvent.className = 'calendar-event';
                    taskEvent.style.backgroundColor = task.color;
                    taskEvent.setAttribute('title', `${task.name}${task.time ? ` às ${task.time}` : ''}`);
                    taskEvent.onclick = (e) => {
                        e.stopPropagation();
                        showTaskDetails(task.id);
                    };
                    dayCell.appendChild(taskEvent);
                });
            }
            
            calendarBody.appendChild(dayCell);
        }
    }
    
    renderCalendarMonth(currentCalendarMonth, currentCalendarYear);
}

function showTaskDetails(taskId) {
    const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    const task = tasks.find(t => t.id === taskId);

    if (!task) {
        showModal('Erro: Tarefa não encontrada.');
        return;
    }

    const modal = document.getElementById('taskDetailsModal');
    modal.currentTask = { ...task }; 
    modal.isEditing = false; 

    renderTaskDetailsModalContent(modal.currentTask, modal.isEditing);
    modal.style.display = 'block';
}

function renderTaskDetailsModalContent(task, isEditing) {
    const modalContent = document.getElementById('taskDetailsContent');
    
    modalContent.innerHTML = `
        <h3><input type="text" id="editTaskName" value="${task.name}" style="width: 100%; padding: 8px; margin-bottom: 5px; border-radius: 5px; border: 1px solid #ddd;" ${isEditing ? '' : 'readonly'}></h3>
        <p><strong>Descrição:</strong> <textarea id="editTaskDescription" style="width: 100%; padding: 8px; margin-bottom: 5px; border-radius: 5px; border: 1px solid #ddd;" ${isEditing ? '' : 'readonly'}>${task.description || ''}</textarea></p>
        <p><strong>Data:</strong> <input type="date" id="editTaskDate" value="${task.date}" style="width: 100%; padding: 8px; margin-bottom: 5px; border-radius: 5px; border: 1px solid #ddd;" ${isEditing ? '' : 'readonly'}></p>
        <p><strong>Hora:</strong> <input type="time" id="editTaskTime" value="${task.time || ''}" style="width: 100%; padding: 8px; margin-bottom: 5px; border-radius: 5px; border: 1px solid #ddd;" ${isEditing ? '' : 'readonly'}></p>
        <p><strong>Prioridade:</strong> 
            <select id="editTaskPriority" style="width: 100%; padding: 8px; margin-bottom: 5px; border-radius: 5px; border: 1px solid #ddd;" ${isEditing ? '' : 'disabled'}>
                <option value="nao-urgente" ${task.priority === 'nao-urgente' ? 'selected' : ''}>Não Urgente</option>
                <option value="urgente" ${task.priority === 'urgente' ? 'selected' : ''}>Urgente</option>
                <option value="prioritaria" ${task.priority === 'prioritaria' ? 'selected' : ''}>Prioritária</option>
                <option value="social" ${task.priority === 'social' ? 'selected' : ''}>Social (Aniversário)</option>
                <option value="viagem" ${task.priority === 'viagem' ? 'selected' : ''}>Viagem</option>
            </select>
        </p>
        ${task.isTravel && task.lat && task.lng ? `<p><strong>Localização:</strong> ${task.lat}, ${task.lng}</p>` : ''}
        <div class="task-actions centered" style="margin-top: 20px;">
            <button class="btn-primary" id="toggleEditButton" onclick="toggleEditMode('${task.id}')"><i class="fas fa-edit"></i> ${isEditing ? 'Guardar Alterações' : 'Alterar Tarefa'}</button>
            <button class="btn-task-complete" onclick="toggleTaskCompletion('${task.id}'); closeModal('taskDetailsModal');"><i class="fas fa-check"></i> ${task.isCompleted ? 'Marcar como incompleto' : 'Marcar como completo'}</button>
            <button class="btn-task-reminder" onclick="addReminder({id: '${task.id}', name: '${task.name}', date: '${task.date}', time: '${task.time}'}); closeModal('taskDetailsModal');"><i class="fas fa-bell"></i> Lembrete</button>
            <button class="btn-task-calendar" onclick="generateICS({id: '${task.id}', name: '${task.name}', date: '${task.date}', time: '${task.time}', description: '${task.description}'}, true); closeModal('taskDetailsModal');"><i class="fas fa-calendar-plus"></i> ICS</button>
            <button class="btn-task-whatsapp" onclick="shareWhatsApp({id: '${task.id}', name: '${task.name}', date: '${task.date}', time: '${task.time}'}); closeModal('taskDetailsModal');"><i class="fab fa-whatsapp"></i> WhatsApp</button>
            ${task.isTravel && task.lat && task.lng ? `<button class="btn-task-navigate" onclick="navigateToTask('${task.id}'); closeModal('taskDetailsModal');"><i class="fas fa-route"></i> Rota</button>` : ''}
            <button class="btn-task-delete" onclick="deleteTask('${task.id}'); closeModal('taskDetailsModal');"><i class="fas fa-trash-alt"></i> Eliminar</button>
        </div>
    `;

    if (isEditing) {
        document.getElementById('editTaskPriority').addEventListener('change', () => {
        });
    }
}

function toggleEditMode(taskId) {
    const modal = document.getElementById('taskDetailsModal');
    
    if (modal.isEditing) {
        saveEditedTask();
    } else {
        modal.isEditing = true;
        renderTaskDetailsModalContent(modal.currentTask, true);
    }
}


function saveEditedTask() {
    const modal = document.getElementById('taskDetailsModal');
    const task = modal.currentTask;

    if (!task) {
        showModal('Erro: Nenhuma tarefa selecionada para edição.');
        return;
    }

    const newName = document.getElementById('editTaskName').value.trim();
    const newDescription = document.getElementById('editTaskDescription').value.trim();
    const newDate = document.getElementById('editTaskDate').value;
    const newTime = document.getElementById('editTaskTime').value;
    const newPriority = document.getElementById('editTaskPriority').value;

    if (!newName || !newDate) {
        showModal('Por favor, preencha o nome e a data da tarefa.');
        modal.isEditing = true;
        renderTaskDetailsModalContent(task, true);
        return;
    }

    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    const taskIndex = tasks.findIndex(t => t.id === task.id);

    if (taskIndex !== -1) {
        tasks[taskIndex].name = newName;
        tasks[taskIndex].description = newDescription;
        tasks[taskIndex].date = newDate;
        tasks[taskIndex].time = newTime;
        tasks[taskIndex].priority = newPriority;

        switch (newPriority) {
            case 'prioritaria': tasks[taskIndex].color = '#f44336'; break;
            case 'urgente': tasks[taskIndex].color = '#ff9800'; break;
            case 'nao-urgente': tasks[taskIndex].color = '#4caf50'; break;
            case 'social': tasks[taskIndex].color = '#2196f3'; break;
            case 'viagem': tasks[taskIndex].color = '#FFD600'; break;
            default: tasks[taskIndex].color = '#9e9e9e'; 
        }

        localStorage.setItem('tasks', JSON.stringify(tasks));
        showModal('Tarefa atualizada com sucesso!');
        modal.isEditing = false;
        modal.currentTask = tasks[taskIndex]; 
        renderTaskDetailsModalContent(tasks[taskIndex], false); 
        renderTaskList();
        renderCalendar(); 
    } else {
        showModal('Erro: Tarefa não encontrada para atualização.');
        modal.isEditing = true;
        renderTaskDetailsModalContent(task, true);
    }
}

function toggleTaskCompletion(taskId) {
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    const taskIndex = tasks.findIndex(task => task.id === taskId);
    if (taskIndex !== -1) {
        tasks[taskIndex].isCompleted = !tasks[taskIndex].isCompleted;
        localStorage.setItem('tasks', JSON.stringify(tasks));
        showModal(tasks[taskIndex].isCompleted ? 'Tarefa marcada como completa!' : 'Tarefa marcada como incompleta.');
        renderTaskList(); 
        renderCalendar();
    }
}

function deleteTask(taskId) {
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    tasks = tasks.filter(task => task.id !== taskId);
    localStorage.setItem('tasks', JSON.stringify(tasks));
    showModal('Tarefa eliminada.');
    renderTaskList(); 
    renderCalendar(); 
}

function navigateToTask(taskId) {
    const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    const task = tasks.find(t => t.id === taskId);
    if (task && task.isTravel && task.lat && task.lng) {
        showTransportModeSelection(task.lat, task.lng, task.name);
    } else {
        showModal('Tarefa não é uma viagem ou não tem coordenadas válidas.');
    }
}

// --- Funções de Horários ---
function renderSchedule(routeName) {
    const resultDiv = document.getElementById('scheduleResult');
    resultDiv.innerHTML = '';
    const schedule = window.appData.scheduleData[routeName];
    if (!schedule) {
        resultDiv.innerHTML = '<p class="no-more-buses">Horário não encontrado para a rota selecionada.</p>';
        return;
    }
    const today = new Date();
    const dayOfWeek = today.getDay();
    const currentTime = today.getHours() * 60 + today.getMinutes();
    let currentDayTimes;
    let currentDayText;
    if (dayOfWeek === 0) { currentDayTimes = schedule.Sunday || []; currentDayText = 'Domingo'; }
    else if (dayOfWeek === 6) { currentDayTimes = schedule.weekend || []; currentDayText = 'Sábado'; }
    else { currentDayTimes = schedule.weekday || []; currentDayText = 'Dia de Semana'; }
    let upcomingTimes = currentDayTimes.filter(time => {
        const [h, m] = time.split(':').map(Number);
        const busTime = h * 60 + m;
        return busTime > currentTime;
    });
    let nextBusTime = null;
    let nextBusDayText = currentDayText;
    let nextUpcomingTimes = [];
    if (upcomingTimes.length > 0) {
        nextBusTime = upcomingTimes[0];
        nextUpcomingTimes = upcomingTimes.slice(1, 5);
    } else {
        let nextDay = dayOfWeek;
        let foundNextDay = false;
        while (!foundNextDay) {
            nextDay = (nextDay + 1) % 7;
            let nextDaySchedule;
            let nextDayText;
            if (nextDay === 0) { nextDaySchedule = schedule.Sunday || []; nextDayText = 'Próximo Domingo'; }
            else if (nextDay === 6) { nextDaySchedule = schedule.weekend || []; nextDayText = 'Próximo Sábado'; }
            else { nextDaySchedule = schedule.weekday || []; nextDayText = 'Próxima Segunda-feira'; if (dayOfWeek !== 6) nextDayText = 'Amanhã'; }
            if (nextDaySchedule.length > 0) {
                nextBusTime = nextDaySchedule[0];
                nextBusDayText = nextDayText;
                nextUpcomingTimes = nextDaySchedule.slice(1, 5);
                foundNextDay = true;
            }
            if (nextDay === dayOfWeek) break;
        }
    }
    let html = '';
    if (nextBusTime) {
        html += `
            <div class="schedule-info">
                <div class="next-bus">
                    <h2>Próximo autocarro</h2>
                    <span class="day-indicator">${nextBusDayText}</span>
                    <div class="next-time">
                        <i class="fa-solid fa-bus"></i>
                        <span>${nextBusTime}</span>
                    </div>
                    <span class="time-remaining" id="timeRemaining-${routeName}">Calculando...</span>
                    <div class="action-buttons centered" style="margin-top: 15px;">
                        <button class="btn-reminder" onclick="addReminder({routeName: '${routeName}', time: '${nextBusTime}'})"><i class="fa-solid fa-bell"></i></button>
                        <button class="btn-calendar" onclick="generateICS({routeName: '${routeName}', time: '${nextBusTime}'})"><i class="fa-solid fa-calendar-plus"></i></button>
                        <button class="btn-whatsapp" onclick="shareWhatsApp({routeName: '${routeName}', time: '${nextBusTime}'})"><i class="fa-brands fa-whatsapp"></i></button>
                    </div>
                </div>
            </div>
        `;
    } else {
        html += `<div class="schedule-info"><p class="no-more-buses">Não há horários disponíveis para os próximos dias.</p></div>`;
    }
    if (nextUpcomingTimes.length > 0) {
        html += `<div class="upcoming-times"><h3>Próximos horários</h3><div class="time-list">`;
        nextUpcomingTimes.forEach(time => {
            html += `
                <div class="time-item">
                    <span>${time}</span>
                    <div class="action-buttons">
                        <button class="btn-reminder" onclick="addReminder({routeName: '${routeName}', time: '${time}'})"><i class="fa-solid fa-bell"></i></button>
                        <button class="btn-calendar" onclick="generateICS({routeName: '${routeName}', time: '${time}'})"><i class="fa-solid fa-calendar-plus"></i></button>
                        <button class="btn-whatsapp" onclick="shareWhatsApp({routeName: '${routeName}', time: '${time}'})"><i class="fa-brands fa-whatsapp"></i></button>
                    </div>
                </div>
            `;
        });
        html += `</div></div>`;
    }
    resultDiv.innerHTML = html;
    if (nextBusTime) {
        updateTimeRemaining(routeName, nextBusTime);
        setInterval(() => updateTimeRemaining(routeName, nextBusTime), 60000);
    }
}

function updateTimeRemaining(routeName, nextTime) {
    const now = new Date();
    const [nextHour, nextMinute] = nextTime.split(':').map(Number);
    const nextBus = new Date(now.getFullYear(), now.getMonth(), now.getDate(), nextHour, nextMinute);
    if (nextBus < now) nextBus.setDate(nextBus.getDate() + 1);
    const diff = nextBus.getTime() - now.getTime();
    if (diff <= 0) {
        document.getElementById(`timeRemaining-${routeName}`).innerText = "Partiu!";
        return;
    }
    const minutes = Math.floor((diff / 1000 / 60) % 60);
    const hours = Math.floor(diff / 1000 / 60 / 60);
    let timeString = '';
    if (hours > 0) timeString += `${hours}h `;
    timeString += `${minutes}min`;
    document.getElementById(`timeRemaining-${routeName}`).innerText = `Faltam ${timeString}`;
}

function updateCurrentTime() {
    const now = new Date();
    const timeOptions = { hour: '2-digit', minute: '2-digit' };
    const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
    const timeString = now.toLocaleTimeString('pt-PT', timeOptions);
    const dateString = now.toLocaleDateString('pt-PT', dateOptions);
    document.getElementById('currentTime').innerText = `${timeString} - ${dateString}`;
}

// =======================================================================
// === NOVAS FUNÇÕES JAVASCRIPT PARA AS NOVAS FUNCIONALIDADES ===========
// =======================================================================

// --- Funções da Aba de Notas ---
function saveNote() {
    const title = document.getElementById('noteTitleInput').value;
    const content = document.getElementById('noteContentInput').value;

    if (title.trim() === '' || content.trim() === '') {
        alert('Por favor, preencha o título e o conteúdo da nota.');
        return;
    }

    if (noteToEditId) {
        const noteIndex = notes.findIndex(note => note.id === noteToEditId);
        if (noteIndex !== -1) {
            notes[noteIndex].title = title;
            notes[noteIndex].content = content;
        }
        noteToEditId = null; 
        document.getElementById('noteTitleInput').value = '';
        document.getElementById('noteContentInput').value = '';
        document.querySelector('.note-form button').textContent = 'Guardar Nota';
    } else {
        const newNote = {
            id: Date.now(),
            title: title,
            content: content
        };
        notes.push(newNote);
        document.getElementById('noteTitleInput').value = '';
        document.getElementById('noteContentInput').value = '';
    }

    localStorage.setItem('notes', JSON.stringify(notes));
    renderNotes();
}

function renderNotes() {
    const notesList = document.getElementById('notesList');
    notesList.innerHTML = '';
    if (notes.length === 0) {
        notesList.innerHTML = '<p class="no-items">Nenhuma nota guardada.</p>';
        return;
    }
    notes.forEach(note => {
        const noteItem = document.createElement('div');
        noteItem.className = 'note-item';
        noteItem.innerHTML = `
            <h4>${note.title}</h4>
            <p>${note.content}</p>
            <div class="note-actions">
                <button class="btn-note-edit" onclick="editNote(this)">
                    <i class="fa-solid fa-pen-to-square"></i>
                </button>
                <button class="btn-note-task" onclick="addNoteToToDoList(this)">
                    <i class="fa-solid fa-list-check"></i>
                </button>
                <button class="btn-note-delete" onclick="deleteNote(this)">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        `;
        noteItem.dataset.noteId = note.id;
        notesList.appendChild(noteItem);
    });
}
function loadNotes() {
    const savedNotes = localStorage.getItem('notes');
    if (savedNotes) {
        notes = JSON.parse(savedNotes);
    }
    renderNotes();
}

function deleteNote(button) {
    const noteItem = button.closest('.note-item');
    const noteId = parseInt(noteItem.dataset.noteId);
    notes = notes.filter(note => note.id !== noteId);
    localStorage.setItem('notes', JSON.stringify(notes));
    renderNotes();
}

function editNote(button) {
    const noteItem = button.closest('.note-item');
    noteToEditId = parseInt(noteItem.dataset.noteId);
    const note = notes.find(n => n.id === noteToEditId);

    document.getElementById('noteTitleInput').value = note.title;
    document.getElementById('noteContentInput').value = note.content;
    document.querySelector('.note-form button').textContent = 'Atualizar Nota';
    document.getElementById('notes').scrollIntoView({ behavior: 'smooth' });
}

function addNoteAsTask(noteId) {
    let notes = JSON.parse(localStorage.getItem('notes')) || [];
    const note = notes.find(n => n.id === noteId);

    if (note) {
        document.getElementById('taskNameInput').value = note.title;
        document.getElementById('taskDescriptionInput').value = note.content;
        
        document.getElementById('taskDateInput').valueAsDate = new Date();

        showTab('toDoList');
        showToDoSubTab('taskFormTab');

        showModal(`A nota "${note.title}" foi pré-preenchida. Complete os detalhes e adicione a tarefa.`);
    }
}

// --- Funções da Aba de Meteorologia (Refatoradas) ---
const weatherIconMap = {
    0: 'sun', 1: 'cloud-sun', 2: 'cloud-sun', 3: 'cloud', 45: 'smog', 48: 'smog',
    51: 'cloud-showers-heavy', 53: 'cloud-showers-heavy', 55: 'cloud-showers-heavy',
    56: 'cloud-showers-heavy', 57: 'cloud-showers-heavy', 61: 'cloud-rain',
    63: 'cloud-rain', 65: 'cloud-showers-heavy', 66: 'cloud-rain', 67: 'cloud-showers-heavy',
    71: 'snowflake', 73: 'snowflake', 75: 'snowflake', 77: 'snowflake',
    80: 'cloud-showers-heavy', 81: 'cloud-showers-heavy', 82: 'cloud-showers-heavy',
    85: 'snowflake', 86: 'snowflake', 95: 'bolt', 96: 'bolt', 99: 'bolt'
};

const weatherDescriptionMap = {
    0: 'Céu limpo', 1: 'Principalmente limpo', 2: 'Parcialmente nublado', 3: 'Céu nublado',
    45: 'Nevoeiro', 48: 'Nevoeiro geado', 51: 'Chuvisco fraco', 53: 'Chuvisco moderado',
    55: 'Chuvisco intenso', 56: 'Chuvisco gelado fraco', 57: 'Chuvisco gelado intenso',
    61: 'Chuva fraca', 63: 'Chuva moderada', 65: 'Chuva intensa',
    66: 'Chuva gelada fraca', 67: 'Chuva gelada intensa', 71: 'Queda de neve fraca',
    73: 'Queda de neve moderada', 75: 'Queda de neve intensa', 77: 'Grãos de neve',
    80: 'Aguaceiros fracos', 81: 'Aguaceiros moderados', 82: 'Aguaceiros violentos',
    85: 'Aguaceiros de neve fraca', 86: 'Aguaceiros de neve intensa', 95: 'Trovoada',
    96: 'Trovoada com granizo fraco', 99: 'Trovoada com granizo intenso'
};

function setWeatherUIState(state, message = '') {
    const weatherContainer = document.getElementById('weatherInfoContainer');
    if (!weatherContainer) return;

    if (state === 'loading') {
        weatherContainer.innerHTML = `<p style="padding: 20px; text-align: center;">${message}</p>`;
    } else if (state === 'error') {
        weatherContainer.innerHTML = `<div class="no-items"><p>${message}</p></div>`;
    } else if (state === 'clear') {
        weatherContainer.innerHTML = '';
    }
}

async function getWeather(lat, lon, cityName) {
    setWeatherUIState('loading', 'A obter previsão do tempo...');
    try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&forecast_days=7`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Erro na API de meteorologia: ${response.statusText}`);
        
        const data = await response.json();
        if (!data.current || !data.daily) throw new Error('Dados de meteorologia inválidos recebidos da API.');

        displayWeather(data, cityName);
    } catch (error) {
        console.error("Erro ao obter dados de meteorologia:", error);
        setWeatherUIState('error', `Não foi possível obter a previsão do tempo. ${error.message}`);
    }
}

async function getWeatherBySearch() {
    const city = document.getElementById('citySearchInput').value.trim();
    if (!city) {
        showModal('Por favor, insira o nome de uma cidade.');
        return;
    }

    setWeatherUIState('loading', `A procurar por "${city}"...`);

    try {
        const geocodeUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city)}&format=json&limit=1`;
        const geocodeResponse = await fetch(geocodeUrl, { headers: { 'User-Agent': 'AppDaKika/1.0' } });
        if (!geocodeResponse.ok) throw new Error(`Erro de geocodificação: ${geocodeResponse.statusText}`);

        const geocodeData = await geocodeResponse.json();
        
        if (geocodeData && geocodeData.length > 0) {
            const lat = geocodeData[0].lat;
            const lon = geocodeData[0].lon;
            const foundCityName = geocodeData[0].display_name.split(',')[0];
            await getWeather(lat, lon, foundCityName);
        } else {
            setWeatherUIState('error', `Cidade "${city}" não encontrada. Por favor, tente novamente.`);
        }
    } catch (error) {
        console.error("Erro na pesquisa por cidade:", error);
        setWeatherUIState('error', `Erro ao pesquisar cidade. ${error.message}`);
    }
}

function getWeatherByCurrentLocation() {
    if (!navigator.geolocation) {
        setWeatherUIState('error', 'Geolocalização não é suportada por este navegador.');
        return;
    }

    setWeatherUIState('loading', 'A obter a sua localização...');

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            setWeatherUIState('loading', 'Localização obtida. A obter nome da cidade...');

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=10`, { headers: { 'User-Agent': 'AppDaKika/1.0' } });
                if (!response.ok) throw new Error(`Erro de geocodificação inversa: ${response.statusText}`);

                const data = await response.json();
                const cityName = data?.address?.city || data?.address?.town || data?.address?.village || "Localização Atual";
                await getWeather(lat, lon, cityName);
            } catch (error) {
                console.error("Erro na geocodificação inversa, a obter meteorologia de qualquer forma:", error);
                setWeatherUIState('loading', 'Não foi possível obter o nome da cidade. A obter previsão do tempo...');
                await getWeather(lat, lon, "Localização Atual");
            }
        },
        (error) => {
            console.error("Erro de geolocalização:", error);
            let message = 'Ocorreu um erro ao obter a sua localização.';
            if (error.code === error.PERMISSION_DENIED) {
                message = 'Permissão de localização negada. Por favor, autorize o acesso ou pesquise por uma cidade.';
            }
            setWeatherUIState('error', message);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
    );
}

function displayWeather(data, cityName) {
    const weatherContainer = document.getElementById('weatherInfoContainer');
    const currentCode = data.current.weather_code;
    const currentDescription = weatherDescriptionMap[currentCode] || 'Condições desconhecidas';
    const currentIcon = weatherIconMap[currentCode] || 'question-circle';

    let forecastHtml = '<div class="weather-forecast">';
    data.daily.time.forEach((day, index) => {
        const date = new Date(day);
        const dayName = date.toLocaleDateString('pt-PT', { weekday: 'short' });
        const dayCode = data.daily.weather_code[index];
        const dayIcon = weatherIconMap[dayCode] || 'question-circle';
        const maxTemp = Math.round(data.daily.temperature_2m_max[index]);
        const minTemp = Math.round(data.daily.temperature_2m_min[index]);
        
        forecastHtml += `
            <div class="forecast-day">
                <h4>${dayName}</h4>
                <i class="fas fa-${dayIcon}"></i>
                <div class="temps">
                    <span class="max">${maxTemp}&deg;</span> / <span class="min">${minTemp}&deg;</span>
                </div>
            </div>
        `;
    });
    forecastHtml += '</div>';

    weatherContainer.innerHTML = `
        <div id="weatherInfo" class="weather-info">
            <h3 id="weatherCity">${cityName}</h3>
            <p id="weatherDescription" class="description">${currentDescription}</p>
            <i id="weatherIcon" class="weather-icon fas fa-${currentIcon}" style="font-size: 100px; color: #4facfe;"></i>
            <p id="weatherTemp" class="temp">${Math.round(data.current.temperature_2m)}&deg;C</p>
            <p id="weatherDetails">
                Vento: <span id="windSpeed">${data.current.wind_speed_10m}</span> km/h<br>
                Humidade: <span id="humidity">${data.current.relative_humidity_2m}</span>%
            </p>
        </div>
        ${forecastHtml}
    `;
}

// --- Funções da Aba de Despesas ---
function showExpenseSubTab(subTabId) {
    document.querySelectorAll('#expenses .expense-sub-content > div').forEach(subTab => {
        subTab.style.display = 'none';
    });
    document.querySelectorAll('#expenses .tab-buttons button').forEach(button => {
        button.classList.remove('active');
    });

    document.getElementById(subTabId).style.display = 'block';
    
    const button = document.querySelector(`#expenses .tab-buttons button[onclick*="${subTabId}"]`);
    if (button) {
        button.classList.add('active');
    }

    if (subTabId === 'addExpenseTab') {
        loadExpenseCategoriesIntoSelect('expenseCategorySelect');
        document.getElementById('expenseDateInput').valueAsDate = new Date();
    } else if (subTabId === 'manageCategoriesTab') {
        renderExpenseCategories();
    } else if (subTabId === 'viewExpensesTab') {
        renderExpenses('daily');
    }
}

function loadExpenseCategoriesIntoSelect(selectId) {
    const categories = JSON.parse(localStorage.getItem('expenseCategories')) || ['Geral'];
    const select = document.getElementById(selectId);
    select.innerHTML = '';
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
    });
}

function addExpenseCategory() {
    const newCategoryInput = document.getElementById('newCategoryInput');
    const newCategory = newCategoryInput.value.trim();
    if (newCategory) {
        let categories = JSON.parse(localStorage.getItem('expenseCategories')) || ['Geral'];
        if (!categories.includes(newCategory)) {
            categories.push(newCategory);
            localStorage.setItem('expenseCategories', JSON.stringify(categories));
            renderExpenseCategories();
            newCategoryInput.value = '';
            loadExpenseCategoriesIntoSelect('expenseCategorySelect');
            loadExpenseCategoriesIntoSelect('editExpenseCategory');
        } else {
            showModal('Essa categoria já existe.');
        }
    }
}

function renderExpenseCategories() {
    const categoryList = document.getElementById('categoryList');
    let categories = JSON.parse(localStorage.getItem('expenseCategories')) || ['Geral'];
    categoryList.innerHTML = '';
    categories.forEach(category => {
        const item = document.createElement('li');
        item.className = 'category-item';
        item.innerHTML = `
            <span>${category}</span>
            <div class="category-actions">
                <button class="btn-edit-category" onclick="editExpenseCategory('${category}')" title="Editar Categoria">
                    <i class="fas fa-edit"></i>
                </button>
                ${category !== 'Geral' ? `<button class="btn-delete-category" onclick="deleteExpenseCategory('${category}')" title="Apagar Categoria">
                    <i class="fas fa-trash-alt"></i>
                </button>` : ''}
            </div>
        `;
        categoryList.appendChild(item);
    });
}

function editExpenseCategory(oldCategoryName) {
    const newCategoryName = prompt(`Editar a categoria '${oldCategoryName}':`, oldCategoryName);
    if (newCategoryName && newCategoryName.trim() !== '' && newCategoryName !== oldCategoryName) {
        let categories = JSON.parse(localStorage.getItem('expenseCategories')) || ['Geral'];
        const index = categories.indexOf(oldCategoryName);
        if (index !== -1) {
            categories[index] = newCategoryName;
            localStorage.setItem('expenseCategories', JSON.stringify(categories));
            
            let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            expenses.forEach(expense => {
                if (expense.category === oldCategoryName) {
                    expense.category = newCategoryName;
                }
            });
            localStorage.setItem('expenses', JSON.stringify(expenses));

            renderExpenseCategories();
            loadExpenseCategoriesIntoSelect('expenseCategorySelect');
            loadExpenseCategoriesIntoSelect('editExpenseCategory');
            const activePeriodButton = document.querySelector('#viewExpensesTab .expense-view-controls .active');
            if (activePeriodButton) {
                renderExpenses(activePeriodButton.id.replace('view', '').replace('Btn', '').toLowerCase());
            }
            
            showModal('Categoria atualizada com sucesso!');
        }
    } else if (newCategoryName !== null && newCategoryName.trim() === '') {
        showModal('O nome da categoria não pode ser vazio.');
    }
}

function deleteExpenseCategory(categoryToDelete) {
    let categories = JSON.parse(localStorage.getItem('expenseCategories')) || [];
    categories = categories.filter(c => c !== categoryToDelete);
    localStorage.setItem('expenseCategories', JSON.stringify(categories));
    renderExpenseCategories();
    loadExpenseCategoriesIntoSelect('expenseCategorySelect');
    loadExpenseCategoriesIntoSelect('editExpenseCategory');
}

function addExpense() {
    const amount = parseFloat(document.getElementById('expenseAmountInput').value);
    const description = document.getElementById('expenseDescriptionInput').value.trim();
    const category = document.getElementById('expenseCategorySelect').value;
    const date = document.getElementById('expenseDateInput').value;

    if (isNaN(amount) || amount <= 0 || !description || !category || !date) {
        showModal('Por favor, preencha todos os campos corretamente.');
        return;
    }

    let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
    const newExpense = {
        id: 'expense_' + Date.now(),
        amount: amount,
        description: description,
        category: category,
        date: date
    };

    expenses.push(newExpense);
    localStorage.setItem('expenses', JSON.stringify(expenses));
    showModal('Despesa adicionada com sucesso!');
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseDateInput').valueAsDate = new Date();
    const activePeriodButton = document.querySelector('#viewExpensesTab .expense-view-controls .active');
    if (activePeriodButton) {
        renderExpenses(activePeriodButton.id.replace('view', '').replace('Btn', '').toLowerCase());
    }
}

function renderExpenses(period) {
    document.querySelectorAll('.expense-view-controls button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`view${period.charAt(0).toUpperCase() + period.slice(1)}Btn`).classList.add('active');

    const expenseList = document.getElementById('expenseList');
    const expenseTotalDiv = document.getElementById('expenseTotal');
    const expensePeriodTitle = document.getElementById('expensePeriodTitle');
    expenseList.innerHTML = '';
    let total = 0;

    const allExpenses = JSON.parse(localStorage.getItem('expenses')) || [];
    const today = new Date();
    let filteredExpenses = [];

    switch (period) {
        case 'daily':
            expensePeriodTitle.textContent = 'Despesas de Hoje';
            filteredExpenses = allExpenses.filter(e => e.date === today.toISOString().split('T')[0]);
            break;
        case 'weekly':
            expensePeriodTitle.textContent = 'Despesas desta Semana';
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            filteredExpenses = allExpenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate >= startOfWeek && expenseDate <= endOfWeek;
            });
            break;
        case 'monthly':
            expensePeriodTitle.textContent = 'Despesas deste Mês';
            filteredExpenses = allExpenses.filter(e => e.date.startsWith(today.toISOString().substring(0, 7)));
            break;
        case 'annually':
            expensePeriodTitle.textContent = 'Despesas deste Ano';
            filteredExpenses = allExpenses.filter(e => e.date.startsWith(today.getFullYear().toString()));
            break;
    }

    if (filteredExpenses.length === 0) {
        expenseList.innerHTML = '<p class="no-items">Nenhuma despesa neste período.</p>';
        expenseTotalDiv.textContent = 'Total: 0.00 €';
        if (expenseChart) expenseChart.destroy();
        document.getElementById('expenseChart').style.display = 'none';
        return;
    }

    document.getElementById('expenseChart').style.display = 'block';
    filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

    filteredExpenses.forEach(expense => {
        const item = document.createElement('li');
        item.className = 'expense-item';
        item.innerHTML = `
            <div>
                <strong>${expense.description}</strong><br>
                <small>${expense.category} - ${new Date(expense.date).toLocaleDateString('pt-PT')}</small>
            </div>
            <div class="expense-actions">
                <span>${expense.amount.toFixed(2)} €</span>
                <button class="btn-edit-expense" onclick="editExpense('${expense.id}')" title="Editar Despesa">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-delete-expense" onclick="deleteExpense('${expense.id}')" title="Apagar Despesa">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        `;
        expenseList.appendChild(item);
        total += expense.amount;
    });

    expenseTotalDiv.textContent = `Total: ${total.toFixed(2)} €`;
    renderExpenseChart(filteredExpenses);
}

function editExpense(expenseId) {
    let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
    const expenseToEdit = expenses.find(e => e.id === expenseId);

    if (expenseToEdit) {
        loadExpenseCategoriesIntoSelect('editExpenseCategory');
        document.getElementById('editExpenseId').value = expenseToEdit.id;
        document.getElementById('editExpenseAmount').value = expenseToEdit.amount;
        document.getElementById('editExpenseDescription').value = expenseToEdit.description;
        document.getElementById('editExpenseCategory').value = expenseToEdit.category;
        document.getElementById('editExpenseDate').value = expenseToEdit.date;
        document.getElementById('editExpenseModal').style.display = 'block';
    } else {
        showModal('Despesa não encontrada para edição.');
    }
}

function saveEditedExpense() {
    const expenseId = document.getElementById('editExpenseId').value;
    const newAmount = parseFloat(document.getElementById('editExpenseAmount').value);
    const newDescription = document.getElementById('editExpenseDescription').value.trim();
    const newCategory = document.getElementById('editExpenseCategory').value;
    const newDate = document.getElementById('editExpenseDate').value;

    if (isNaN(newAmount) || newAmount <= 0 || !newDescription || !newCategory || !newDate) {
        showModal('Por favor, preencha todos os campos corretamente para editar.');
        return;
    }

    let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
    const expenseIndex = expenses.findIndex(e => e.id === expenseId);

    if (expenseIndex !== -1) {
        expenses[expenseIndex] = {
            id: expenseId,
            amount: newAmount,
            description: newDescription,
            category: newCategory,
            date: newDate
        };
        localStorage.setItem('expenses', JSON.stringify(expenses));
        showModal('Despesa atualizada com sucesso!');
        closeModal('editExpenseModal');
        const activePeriodButton = document.querySelector('#viewExpensesTab .expense-view-controls .active');
        if (activePeriodButton) {
            renderExpenses(activePeriodButton.id.replace('view', '').replace('Btn', '').toLowerCase());
        }
    } else {
        showModal('Erro: Despesa não encontrada para atualização.');
    }
}

function deleteExpense(expenseId) {
    let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
    expenses = expenses.filter(e => e.id !== expenseId);
    localStorage.setItem('expenses', JSON.stringify(expenses));
    showModal('Despesa eliminada com sucesso!');
    const activePeriodButton = document.querySelector('#viewExpensesTab .expense-view-controls .active');
    if (activePeriodButton) {
        renderExpenses(activePeriodButton.id.replace('view', '').replace('Btn', '').toLowerCase());
    }
}


function renderExpenseChart(expenses) {
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const expensesByCategory = expenses.reduce((acc, expense) => {
        acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
        return acc;
    }, {});

    const labels = Object.keys(expensesByCategory);
    const data = Object.values(expensesByCategory);

    if (expenseChart) {
        expenseChart.destroy();
    }

    expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                label: 'Despesas por Categoria',
                data: data,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                    '#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3',
                    '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39',
                    '#ffeb3b', '#ffc107', '#ff9800', '#ff5722', '#795548', '#9e9e9e', '#607d8b'
                ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Distribuição de Despesas por Categoria'
                }
            }
        }
    });
}

// --- Funções da Calculadora ---
const calculatorDisplay = document.getElementById('calculatorDisplay');
let currentExpression = '0';

function calculatorInput(value) {
    if (currentExpression === '0' && value !== '.') {
        currentExpression = '';
    }
    if (value === 'Math.PI') {
        currentExpression += 'π';
    } else {
        currentExpression += value;
    }
    updateCalculatorDisplay();
}

function calculatorClear() {
    currentExpression = '0';
    updateCalculatorDisplay();
}

function calculatorBackspace() {
    currentExpression = currentExpression.slice(0, -1);
    if (currentExpression === '') {
        currentExpression = '0';
    }
    updateCalculatorDisplay();
}

function calculateResult() {
    try {
        let evalExpression = currentExpression.replace(/π/g, 'Math.PI');
        evalExpression = evalExpression.replace(/sin\(/g, 'Math.sin(Math.PI / 180 *');
        evalExpression = evalExpression.replace(/cos\(/g, 'Math.cos(Math.PI / 180 *');
        evalExpression = evalExpression.replace(/tan\(/g, 'Math.tan(Math.PI / 180 *');
        
        const result = eval(evalExpression);
        currentExpression = result.toString();
        updateCalculatorDisplay();
    } catch (error) {
        currentExpression = 'Erro';
        updateCalculatorDisplay();
        currentExpression = '0';
    }
}

function updateCalculatorDisplay() {
    calculatorDisplay.textContent = currentExpression;
}

// --- Funções do Temporizador/Cronómetro ---
let timerInterval;
let stopwatchInterval;
let timerSecondsRemaining = 0;
let stopwatchTime = 0;
let timerAudio = new Audio('https://www.soundjay.com/buttons/beep-07.wav');

function showTimerSubTab(tabId) {
    document.querySelectorAll('#timer .timer-container, #timer .stopwatch-container').forEach(tab => {
        tab.style.display = 'none';
    });
     document.querySelectorAll('#timer .tab-buttons button').forEach(button => {
        button.classList.remove('active');
    });

    if (tabId === 'timerTab') {
        document.querySelector('#timer .timer-container').style.display = 'block';
    } else {
        document.querySelector('#timer .stopwatch-container').style.display = 'block';
    }
   
    const button = document.querySelector(`#timer .tab-buttons button[onclick*="${tabId}"]`);
    if(button) button.classList.add('active');
}


function startTimer() {
    if (timerSecondsRemaining <= 0) {
        const hours = parseInt(document.getElementById('timerHours').value) || 0;
        const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
        const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
        timerSecondsRemaining = (hours * 3600) + (minutes * 60) + seconds;
    }
    if (timerSecondsRemaining > 0) {
        clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);
    }
}

function pauseTimer() {
    clearInterval(timerInterval);
}

function resetTimer() {
    clearInterval(timerInterval);
    timerSecondsRemaining = 0;
    updateTimerDisplay();
    document.getElementById('timerHours').value = '';
    document.getElementById('timerMinutes').value = '';
    document.getElementById('timerSeconds').value = '';
}

function updateTimer() {
    if (timerSecondsRemaining > 0) {
        timerSecondsRemaining--;
        updateTimerDisplay();
    } else {
        clearInterval(timerInterval);
        timerAudio.play();
        showModal("O tempo acabou!");
    }
}

function updateTimerDisplay() {
    const hours = Math.floor(timerSecondsRemaining / 3600);
    const minutes = Math.floor((timerSecondsRemaining % 3600) / 60);
    const seconds = timerSecondsRemaining % 60;
    document.getElementById('timerDisplay').textContent = 
        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function startStopwatch() {
    clearInterval(stopwatchInterval);
    const startTime = Date.now() - stopwatchTime;
    stopwatchInterval = setInterval(() => {
        stopwatchTime = Date.now() - startTime;
        updateStopwatchDisplay();
    }, 10);
}

function pauseStopwatch() {
    clearInterval(stopwatchInterval);
}

function resetStopwatch() {
    clearInterval(stopwatchInterval);
    stopwatchTime = 0;
    updateStopwatchDisplay();
}

function updateStopwatchDisplay() {
    const totalSeconds = Math.floor(stopwatchTime / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const milliseconds = String(stopwatchTime % 1000).padStart(3, '0');
    document.getElementById('stopwatchDisplay').textContent = 
        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${milliseconds}`;
}

// --- Funções do Conversor ---
function showConverterSubTab(tabId) {
    document.querySelectorAll('#converter > div[id$="Converter"]').forEach(tab => {
        tab.style.display = 'none';
    });
    document.querySelectorAll('#converter .tab-buttons button').forEach(button => {
        button.classList.remove('active');
    });
    document.getElementById(tabId).style.display = 'block';
    const button = document.querySelector(`#converter .tab-buttons button[onclick*="${tabId}"]`);
    if(button) button.classList.add('active');
}

function convertLength() {
    const input = parseFloat(document.getElementById('lengthInput').value);
    const fromUnit = document.getElementById('fromLengthUnit').value;
    const toUnit = document.getElementById('toLengthUnit').value;
    if (isNaN(input)) {
        document.getElementById('lengthOutput').value = '';
        return;
    }

    const toMeters = {
        'm': 1, 'km': 1000, 'cm': 0.01, 'mm': 0.001,
        'mi': 1609.34, 'yd': 0.9144, 'ft': 0.3048, 'in': 0.0254
    };

    const meters = input * toMeters[fromUnit];
    const result = meters / toMeters[toUnit];
    document.getElementById('lengthOutput').value = result.toFixed(5);
}

function convertMass() {
    const input = parseFloat(document.getElementById('massInput').value);
    const fromUnit = document.getElementById('fromMassUnit').value;
    const toUnit = document.getElementById('toMassUnit').value;
    if (isNaN(input)) {
        document.getElementById('massOutput').value = '';
        return;
    }
    const toGrams = {
        'g': 1, 'kg': 1000, 'mg': 0.001, 't': 1000000,
        'lb': 453.592, 'oz': 28.3495
    };
    const grams = input * toGrams[fromUnit];
    const result = grams / toGrams[toUnit];
    document.getElementById('massOutput').value = result.toFixed(5);
}

function convertTemp() {
    const input = parseFloat(document.getElementById('tempInput').value);
    const fromUnit = document.getElementById('fromTempUnit').value;
    const toUnit = document.getElementById('toTempUnit').value;
    if (isNaN(input)) {
        document.getElementById('tempOutput').value = '';
        return;
    }
    let celsius;
    if (fromUnit === 'C') celsius = input;
    else if (fromUnit === 'F') celsius = (input - 32) * 5 / 9;
    else if (fromUnit === 'K') celsius = input - 273.15;

    let result;
    if (toUnit === 'C') result = celsius;
    else if (toUnit === 'F') result = (celsius * 9 / 5) + 32;
    else if (toUnit === 'K') result = celsius + 273.15;

    document.getElementById('tempOutput').value = result.toFixed(2);
}

let currencyRates = {
    'EUR': 1,
    'USD': 1.08,
    'GBP': 0.85,
    'JPY': 162.45
};

function initCurrencyConverter() {
    const savedRates = localStorage.getItem('currencyRates');
    if (savedRates) {
        currencyRates = JSON.parse(savedRates);
    }
    populateCurrencySelects();
    renderCurrencyRates();
}

function populateCurrencySelects() {
    const fromSelect = document.getElementById('fromCurrency');
    const toSelect = document.getElementById('toCurrency');
    fromSelect.innerHTML = '';
    toSelect.innerHTML = '';
    for (const currency in currencyRates) {
        fromSelect.innerHTML += `<option value="${currency}">${currency}</option>`;
        toSelect.innerHTML += `<option value="${currency}">${currency}</option>`;
    }
    fromSelect.value = 'EUR';
    toSelect.value = 'USD';
}

function convertCurrency() {
    const input = parseFloat(document.getElementById('currencyInput').value);
    const fromCurrency = document.getElementById('fromCurrency').value;
    const toCurrency = document.getElementById('toCurrency').value;

    if (isNaN(input)) {
        document.getElementById('currencyOutput').value = '';
        return;
    }

    const valueInEur = input / currencyRates[fromCurrency];
    const result = valueInEur * currencyRates[toCurrency];
    document.getElementById('currencyOutput').value = result.toFixed(2);
}

function renderCurrencyRates() {
    const list = document.getElementById('currencyRatesList');
    list.innerHTML = '';
    for (const currency in currencyRates) {
        if (currency === 'EUR') continue;
        const item = document.createElement('div');
        item.className = 'currency-rate-item';
        item.innerHTML = `
            <span>1 EUR = ${currencyRates[currency]} ${currency}</span>
            <button onclick="deleteCurrencyRate('${currency}')" style="background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">X</button>
        `;
        list.appendChild(item);
    }
}

function addOrUpdateCurrencyRate() {
    const code = document.getElementById('newCurrencyCode').value.toUpperCase();
    const rate = parseFloat(document.getElementById('newCurrencyRate').value);
    if (code && !isNaN(rate) && rate > 0) {
        currencyRates[code] = rate;
        localStorage.setItem('currencyRates', JSON.stringify(currencyRates));
        initCurrencyConverter();
        document.getElementById('newCurrencyCode').value = '';
        document.getElementById('newCurrencyRate').value = '';
    } else {
        showModal("Por favor, insira um código de moeda e uma taxa válidos.");
    }
}

function deleteCurrencyRate(currency) {
    if (currencyRates[currency]) {
        delete currencyRates[currency];
        localStorage.setItem('currencyRates', JSON.stringify(currencyRates));
        initCurrencyConverter();
    }
}

// --- Funções do Leitor de PDF ---
let pdfDoc = null,
    pageNum = 1,
    pageIsRendering = false,
    pageNumIsPending = null;

const pdfCanvas = document.getElementById('pdf-viewer'),
      pdfCtx = pdfCanvas.getContext('2d');

async function loadPdfFromUrl() {
    const url = document.getElementById('pdf-url-input').value;
    if (!url) {
        showModal("Por favor, insira um URL de um ficheiro PDF.");
        return;
    }
    showModal("A carregar o PDF...");
    try {
        const proxyUrl = `https://cors-anywhere.herokuapp.com/${url}`;
        const loadingTask = pdfjsLib.getDocument(proxyUrl);
        pdfDoc = await loadingTask.promise;
        closeModal();
        document.getElementById('pdf-viewer-container').style.display = 'block';
        document.getElementById('pdf-page-count').textContent = pdfDoc.numPages;
        renderPdfPage(pageNum);
    } catch (error) {
        closeModal();
        showModal(`Erro ao carregar o PDF: ${error.message}. Tente outro link.`);
        console.error('Erro ao carregar PDF:', error);
    }
}

const renderPdfPage = num => {
    pageIsRendering = true;
    pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({ scale: 1.5 });
        pdfCanvas.height = viewport.height;
        pdfCanvas.width = viewport.width;
        const renderCtx = {
            canvasContext: pdfCtx,
            viewport
        };
        page.render(renderCtx).promise.then(() => {
            pageIsRendering = false;
            if (pageNumIsPending !== null) {
                renderPdfPage(pageNumIsPending);
                pageNumIsPending = null;
            }
        });
        document.getElementById('pdf-page-num').textContent = num;
    });
};

const queueRenderPage = num => {
    if (pageIsRendering) {
        pageNumIsPending = num;
    } else {
        renderPdfPage(num);
    }
};

const showPrevPage = () => {
    if (pageNum <= 1) return;
    pageNum--;
    queueRenderPage(pageNum);
};

const showNextPage = () => {
    if (pageNum >= pdfDoc.numPages) return;
    pageNum++;
    queueRenderPage(pageNum);
};

document.getElementById('pdf-prev').addEventListener('click', showPrevPage);
document.getElementById('pdf-next').addEventListener('click', showNextPage);


// --- Event Listener DOMContentLoaded ---
document.addEventListener('DOMContentLoaded', () => {
    updateCurrentTime();
    setInterval(updateCurrentTime, 60000);

    document.getElementById('taskPrioritySelect').addEventListener('change', updateTaskColorSelect);
    updateTaskColorSelect();

    fetch('data.json')
        .then(response => {
            if (!response.ok) {
                console.error('Network response was not ok:', response.statusText);
                throw new Error('Erro ao carregar o ficheiro data.json: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            window.appData = data;
            console.log('Dados carregados com sucesso:', window.appData);

            if (window.appData.pontosDeInteresse && window.appData.pontosDeInteresse.length > 0) {
                console.log('Pontos de Interesse carregados:', window.appData.pontosDeInteresse);
            } else {
                console.warn('Nenhum ponto de interesse encontrado em data.json ou a propriedade está vazia/ausente.');
            }

            const routeSelect = document.getElementById('routeSelect');
            if (data.scheduleData) {
                Object.keys(data.scheduleData).forEach(routeName => {
                    const option = document.createElement('option');
                    option.value = routeName;
                    option.textContent = routeName.replace(/-/g, ' ');
                    routeSelect.appendChild(option);
                });
            }
            routeSelect.addEventListener('change', (event) => {
                renderSchedule(event.target.value);
            });
            if (Object.keys(data.scheduleData || {}).length > 0) {
                const firstRoute = Object.keys(data.scheduleData)[0];
                routeSelect.value = firstRoute;
                renderSchedule(firstRoute);
            }
            renderPdfButtons();
            renderReminders();
            renderPontosDeInteresse();
            loadNotes();
            initCurrencyConverter();
        })
        .catch(error => {
            console.error('Erro geral ao carregar os dados:', error);
            showModal('Erro ao carregar os dados. Por favor, tente novamente mais tarde.');
        });
});
    </script>
</body>
</html>