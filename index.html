<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>App da Kika</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="App da Kika" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="application-name" content="App da Kika">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <!-- Ícones para WhatsApp e Calendário -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2xre/j9yR0c2zJ3sF46QeE5a/qQ6P3o9fF6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #FFD600;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .banner {
            background-image: url('https://raw.githubusercontent.com/nc32370a/App-da-Kika/refs/heads/main/banner.PNG');
            background-size: cover;
            background-position: center;
            padding: 20px;
            margin: 0px 0px 25px 0px;
            color: white;
            text-shadow: 1px 1px 5px rgba(0,0,0,0.7);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 150px;
        }
        .current-time { font-size: 18px; opacity: 0.9; }
        .tab-buttons {
            display: flex;
            margin: 0 20px 20px 20px;
            gap: 10px;
        }
        .tab-buttons button {
            flex: 1;
            padding: 10px 0;
            font-weight: 600;
            background-color: #4facfe;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .tab-buttons button.active { background-color: #005bb5; }
        .tab-content { padding: 0 20px 30px 20px; }
        .tab-content > div { display: none; }
        .tab-content > div.active { display: block; }
        .route-selector { margin-bottom: 30px; }
        .route-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }
        .route-selector select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .route-selector select:focus { outline: none; border-color: #4facfe; }
        .schedule-info {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .next-bus { text-align: center; margin-bottom: 25px; }
        .next-bus h2 { color: #333; margin-bottom: 10px; }
        .next-time {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            font-size: 36px; font-weight: bold; color: #4facfe; margin-bottom: 5px;
        }
        .time-remaining {
            font-size: 18px;
            color: #666;
            background: #e3f2fd;
            padding: 8px 16px;
            border-radius: 25px;
            display: inline-block;
        }
        .upcoming-times { margin-top: 25px; }
        .upcoming-times h3 { color: #333; margin-bottom: 15px; font-size: 18px; }
        .time-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 250px;
            margin: 0 auto;
        }
        .time-item {
            background: white;
            border: 2px solid #e1e5e9;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 500;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .time-item.tomorrow {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .day-indicator {
            background: #ff9800;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
        }
        .no-more-buses {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        #map {
            width: 100%;
            height: 350px;
            border-radius: 15px;
            margin-top: 20px;
            margin-bottom: 10px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.10);
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-buttons.centered {
             justify-content: center;
        }
        .action-buttons button {
            border: none;
            border-radius: 5px;
            cursor: pointer;
            padding: 5px 8px;
            color: white;
            transition: background-color 0.2s;
        }
        .action-buttons .btn-reminder {
            background-color: #4caf50;
        }
        .action-buttons .btn-whatsapp {
            background-color: #25D366;
        }
        .action-buttons .btn-calendar {
            background-color: #f44336;
        }
        .action-buttons .btn-navigate {
            background-color: #2196F3;
        }
        .action-buttons .btn-reminder:hover { background-color: #43a047; }
        .action-buttons .btn-whatsapp:hover { background-color: #128C7E; }
        .action-buttons .btn-calendar:hover { background-color: #d32f2f; }
        .action-buttons .btn-navigate:hover { background-color: #1976D2; }
        .whatsapp-share-btn {
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 8px;
            border: none;
            background-color: #25D366;
            color: white;
            cursor: pointer;
        }
        .reminder-list, .poi-list {
            list-style: none;
            padding: 0;
        }
        .reminder-item, .poi-item {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .poi-item {
    flex-direction: row; /* Alterado de 'column' para 'row' */
    justify-content: space-between; /* Adicionado para alinhar os itens */
    align-items: center; /* Adicionado para alinhar verticalmente */
    background-color: #f8f9fa;
        }
        .reminder-details, .poi-details {
            text-align: left;
            flex-grow: 1;
        }
        .reminder-details h4, .poi-details h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .reminder-details p, .poi-details p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        .reminder-remove {
            background: #e91e63;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .reminder-remove:hover {
            background: #c2185b;
        }
 /* Estilos da navegação - Versão Moderna e Minimalista */
.navigation-panel {
    /* As alterações abaixo removem a posição fixa e diminuem a caixa */
    position: static; /* Altera a posição para ficar no fluxo do documento */
    width: 100%; /* Garante que a largura se alinha com o mapa */
    background: #ffffff;
    color: #333;
    padding: 8px; /* Diminui o preenchimento para reduzir o tamanho */
    border-radius: 15px; /* Arredonda as bordas */
    box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Sombra mais subtil */
    margin-top: 10px; /* Adiciona uma pequena margem para separar do mapa */
    z-index: 1000;
    /* As propriedades abaixo podem ser removidas já que não são mais necessárias com 'position: static' */
    /* transform: translateY(100%); */
    /* transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); */
    /* max-height: 30vh; */
    overflow-y: auto;
    font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
    display: none; /* Inicia escondido */
}

.navigation-panel.active {
    display: block; /* Mostra o painel quando a classe 'active' é adicionada */
}

.nav-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 1px solid #e0e0e0; /* Linha divisória mais suave */
    padding-bottom: 15px;
}

.nav-title {
    font-size: 20px;
    font-weight: bold;
    color: #4285F4; /* Cor de destaque para o título */
}

.nav-close {
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 24px;
    transition: color 0.2s;
    line-height: 1; /* Para alinhar o 'x' */
}

.nav-close:hover {
    color: #333;
}

.nav-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    font-size: 14px;
    color: #555;
}

.nav-distance, .nav-duration {
    background: #f1f1f1; /* Fundo mais claro */
    padding: 8px 12px;
    border-radius: 15px;
}

.nav-instruction {
    background: #f9f9f9; /* Fundo muito claro */
    border: 1px solid #e0e0e0;
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 3px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px; /* Diminui o tamanho da fonte */
    background: rgba(255, 255, 255, 0.25);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Sombra subtil */
}

.nav-instruction-icon {
    font-size: 18px;
    width: 20px;
    text-align: center;
    color: #4285F4; /* Ícones em cor de destaque */
}

.nav-instruction-text {
    flex: 1;
    font-size: 13px;
    line-height: 1.3;
}

.nav-instruction-distance {
    font-size: 14px;
    opacity: 0.8;
}

.nav-controls {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.nav-controls button {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
}

.nav-controls button:active {
    transform: scale(0.98);
}

.nav-recalculate {
    background: #FF9800;
    color: white;
}

.nav-recalculate:hover {
    background: #e68900;
}

.nav-stop {
    background: #F44336;
    color: white;
}

.nav-stop:hover {
    background: #d32f2f;
}

.gps-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    opacity: 0.8;
    margin-top: 10px;
}
.gps-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4caf50;
    animation: pulse 2s infinite;
}

/* Animação para o indicador GPS */
@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.5; }
    100% { transform: scale(1); opacity: 1; }
}
        /* Estilos do modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        /* Novos estilos para a tab PDF */
        #pdf .pdf-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        #pdf .pdf-nav button {
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background-color: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        #pdf .pdf-nav button:hover {
            border-color: #4facfe;
            background-color: #e3f2fd;
        }
        #pdf .pdf-nav button.active {
            background-color: #4facfe;
            color: white;
            border-color: #005bb5;
        }
        #pdf .pdf-image-container {
            text-align: center;
        }
        #pdf-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
         /* Estilos do indicador de status de localização */
        .location-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 999;
            display: none;
        }
        .location-status.active {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .location-status .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }
        .location-status.network .status-indicator {
            background: #ff9800;
        }
        .location-status.ip .status-indicator {
            background: #f44336;
        }
        .location-status.default .status-indicator {
            background: #9e9e9e;
        }
        @media (max-width: 480px) {
            .container { margin: 10px; border-radius: 15px; }
            .banner { padding: 15px; height: 120px; }
            .header { padding: 20px 15px; }
            .tab-buttons { margin: 0 10px 20px 10px; gap: 5px; }
            .tab-buttons button { padding: 8px 0; font-size: 14px; }
            .tab-content { padding: 0 10px 20px 10px; }
            #map { height: 250px; }
            .time-item { flex-direction: column; align-items: flex-start; gap: 5px; padding: 10px; }
            .time-item .action-buttons { margin-top: 5px; }
            .time-list { max-width: none; }
        }
        .nav-instruction {
                padding: 12px;
                gap: 10px;
            }
            .nav-instruction-icon {
                font-size: 20px;
                width: 30px;
            }
            .nav-instruction-text {
                font-size: 14px;
            }
        }
    </style>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body>
    <!-- Indicador de status de localização -->
    <div id="locationStatus" class="location-status">
        <div class="status-indicator"></div>
        <span id="locationStatusText">GPS ativo</span>
    </div>

    <div class="container">
        <div class="banner">
            <h1 style="font-size: 2.5rem; margin-bottom: 5px;">App da Kika</h1>
            <div class="current-time" id="currentTime"></div>
        </div>

        <div class="tab-buttons">
            <button id="btnHorarios" class="active" onclick="showTab('horarios')">Horários</button>
            <button id="btnPdf" onclick="showTab('pdf')">PDF</button>
            <button id="btnLembretes" onclick="showTab('lembretes')">Lembretes</button>
            <button id="btnPontosDeInteresse" onclick="showTab('pontosDeInteresse')">Locais</button>
            <button id="btnMapa" onclick="showTab('mapa')">Mapa</button>
        </div>

        <div class="tab-content">
            <div id="horarios" class="active">
                <div class="route-selector">
                    <label for="routeSelect">Selecione a rota:</label>
                    <select id="routeSelect"></select>
                </div>
                <div id="scheduleResult"></div>
            </div>

            <div id="pdf">
                <div class="pdf-nav" id="pdf-nav">
                    <!-- Os botões PDF serão renderizados aqui dinamicamente -->
                </div>
                <div class="pdf-image-container">
                    <img id="pdf-image" src="" alt="Horário em formato PDF">
                </div>
            </div>

            <div id="lembretes">
                <ul class="reminder-list" id="reminderList"></ul>
            </div>

            <div id="pontosDeInteresse">
                <h2 style="font-size: 1.5rem; margin-bottom: 1rem; text-align: center;">Pontos de Interesse</h2>
                <div class="search-container">
                <input type="text" id="poiSearchInput" placeholder="Pesquisar ponto de interesse..." style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #e1e5e9; font-size: 16px;"             oninput="filterPontosDeInteresse(this.value)">
            </div>
                <ul class="poi-list" id="poiList"></ul>
            </div>

            <div id="mapa">
                <div id="map"></div>
    <div id="navigationPanel" class="navigation-panel">
        <div class="nav-header">
            <div class="nav-title">Navegação</div>
            <button class="nav-close" onclick="stopNavigation()">&times;</button>
        </div>
        <div class="nav-info">
            <div class="nav-distance" id="navDistance">0 km</div>
            <div class="nav-duration" id="navDuration">0 min</div>
        </div>
        <div id="navInstructions">
            <!-- As instruções aparecerão aqui -->
        </div>
        <div class="nav-controls">
            <button class="nav-recalculate" onclick="recalculateRoute()">
                <i class="fa-solid fa-route"></i> Recalcular
            </button>
            <button class="nav-stop" onclick="stopNavigation()">
                <i class="fa-solid fa-stop"></i> Parar
            </button>
        </div>
        <div class="gps-status">
            <div class="gps-indicator"></div>
            GPS ativo - Localização atualizada
        </div>
    </div>
    </div>
        </div>
    </div>



    <!-- Modal para mensagens -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p id="modal-message"></p>
        </div>
    </div>

    <script>
        // Configuração do OneSignal
        window.OneSignal = window.OneSignal || [];
        OneSignal.push(function() {
            OneSignal.init({
                appId: "09cf47e1-545a-4a0b-9873-f09cc9a71707",
                safari_web_id: "SEU_SAFARI_WEB_ID",
                serviceWorkerUpdaterPath: 'OneSignalSDKUpdateWorker.js',
                serviceWorkerPath: 'OneSignalSDKWorker.js',
            });
            console.log('OneSignal SDK inicializado.');
        });

        // Variável global para armazenar os dados do JSON
        window.appData = null;
        let map = null;
        let userMarker = null;
        let navigationActive = false;
        let currentRoute = null;
        let routeControl = null;
        let watchId = null;
        let userLocation = null;
        let destinationLocation = null;
        let routeInstructions = [];
        let currentInstructionIndex = 0;
        let currentLocationMethod = 'unknown';

        // Função para criar os ícones dos marcadores do mapa
        function createMapIcon(color) {
            return new L.Icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        // Funções do Modal
        function showModal(message) {
            document.getElementById('modal-message').innerText = message;
            document.getElementById('messageModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
        }
        
        // Função para mostrar status de localização
        function showLocationStatus(method, text) {
            const status = document.getElementById('locationStatus');
            const statusText = document.getElementById('locationStatusText');
            
            status.className = `location-status active ${method}`;
            statusText.textContent = text;
            
            setTimeout(() => {
                status.classList.remove('active');
            }, 5000);
        }

        // Função melhorada para obter localização do usuário com múltiplos métodos
        async function getCurrentLocationPromise() {
            console.log('Iniciando processo de geolocalização...');
            
            // Método 1: Tentar GPS primeiro (com timeout reduzido)
            try {
                console.log('Tentando GPS...');
                const gpsLocation = await tryGPSLocation();
                console.log('GPS bem-sucedido:', gpsLocation);
                currentLocationMethod = 'gps';
                showLocationStatus('gps', 'GPS ativo');
                return gpsLocation;
            } catch (gpsError) {
                console.log('GPS falhou:', gpsError.message);
            }
            
            // Método 2: Tentar localização por rede/Wi-Fi
            try {
                console.log('Tentando localização por rede...');
                const networkLocation = await getLocationByNetwork();
                console.log('Rede bem-sucedida:', networkLocation);
                currentLocationMethod = 'network';
                showLocationStatus('network', 'Localização por rede');
                return networkLocation;
            } catch (networkError) {
                console.log('Rede falhou:', networkError.message);
            }
            
            // Método 3: Tentar localização por IP
            try {
                console.log('Tentando localização por IP...');
                const ipLocation = await getLocationByIP();
                console.log('IP bem-sucedido:', ipLocation);
                currentLocationMethod = 'ip';
                showLocationStatus('ip', 'Localização por IP');
                return ipLocation;
            } catch (ipError) {
                console.log('IP falhou:', ipError.message);
            }
            
            // Método 4: Usar localização padrão de Viseu
            console.log('Usando localização padrão de Viseu');
            const viseuDefault = [40.6617747743044, -7.91556785877083];
            currentLocationMethod = 'default';
            showLocationStatus('default', 'Localização padrão');
            return viseuDefault;
        }

        // Função para tentar GPS (com timeout mais curto)
        function tryGPSLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation API não suportada'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = [position.coords.latitude, position.coords.longitude];
                        resolve(location);
                    },
                    (error) => {
                        let errorMessage = 'Erro GPS desconhecido';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Permissão GPS negada';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'GPS indisponível';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Timeout GPS';
                                break;
                        }
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 8000, // 8 segundos
                        maximumAge: 300000 // 5 minutos
                    }
                );
            });
        }

        // Função para obter localização por rede/Wi-Fi
        function getLocationByNetwork() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation API não suportada'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = [position.coords.latitude, position.coords.longitude];
                        resolve(location);
                    },
                    (error) => {
                        reject(new Error('Localização por rede falhou'));
                    },
                    {
                        enableHighAccuracy: false, // Usar rede em vez de GPS
                        timeout: 10000,
                        maximumAge: 600000 // 10 minutos
                    }
                );
            });
        }

        // Função para obter localização por IP
        async function getLocationByIP() {
            const services = [
                {
                    url: 'https://api.ipgeolocation.io/ipgeo?apiKey=at_free',
                    parser: (data) => data.latitude && data.longitude ? [parseFloat(data.latitude), parseFloat(data.longitude)] : null
                }
            ];
            
            for (const service of services) {
                try {
                    console.log(`Tentando serviço IP: ${service.url}`);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch(service.url, { 
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const coords = service.parser(data);
                    
                    if (coords && !isNaN(coords[0]) && !isNaN(coords[1])) {
                        console.log(`Localização obtida por IP (${service.url}):`, coords);
                        return coords;
                    }
                } catch (serviceError) {
                    console.log(`Serviço ${service.url} falhou:`, serviceError.message);
                    continue;
                }
            }
            
            throw new Error('Todos os serviços de IP falharam');
        }

        // Função para obter ícone de instrução de navegação
        function getInstructionIcon(maneuverType) {
            const iconMap = {
                'turn-right': 'fa-arrow-right',
                'turn-left': 'fa-arrow-left',
                'turn-sharp-right': 'fa-arrow-right',
                'turn-sharp-left': 'fa-arrow-left',
                'turn-slight-right': 'fa-arrow-right',
                'turn-slight-left': 'fa-arrow-left',
                'straight': 'fa-arrow-up',
                'continue': 'fa-arrow-up',
                'merge': 'fa-code-merge',
                'roundabout': 'fa-circle',
                'exit-roundabout': 'fa-circle',
                'fork': 'fa-code-fork',
                'end-of-road': 'fa-arrow-up',
                'use-lane': 'fa-arrow-up',
                'arrive': 'fa-flag-checkered'
            };
            
            return iconMap[maneuverType] || 'fa-arrow-up';
        }

        // Função para calcular rota usando OSRM
        async function calculateRoute(start, end) {
            try {
                console.log('Calculando rota de', start, 'para', end);
                
                // Usar OSRM (OpenStreetMap Routing Machine) - gratuito
                const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson&steps=true`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.routes || data.routes.length === 0) {
                    throw new Error('Nenhuma rota encontrada');
                }
                
                const route = data.routes[0];
                console.log('Rota calculada:', route);
                
                // Processar instruções
                routeInstructions = [];
                if (route.legs && route.legs[0] && route.legs[0].steps) {
                   route.legs[0].steps.forEach(step => {
    let instructionText = step.maneuver.instruction || 'Continue em frente';
    
    // Se houver nome da rua/estrada, incluir na instrução
    if (step.name && step.name.trim() !== '' && step.name !== 'unnamed road') {
        switch(step.maneuver.type) {
            case 'turn-right':
                instructionText = `Vire à direita para ${step.name}`;
                break;
            case 'turn-left':
                instructionText = `Vire à esquerda para ${step.name}`;
                break;
            case 'continue':
            case 'straight':
                instructionText = `Continue em ${step.name}`;
                break;
            default:
                instructionText = step.maneuver.instruction || `Continue para ${step.name}`;
        }
    }
    
    const instruction = {
        instruction: instructionText,
        distance: step.distance > 1000 ? 
            `${(step.distance / 1000).toFixed(1)} km` : 
            `${Math.round(step.distance)} m`,
        icon: getInstructionIcon(step.maneuver.type)
    };
    routeInstructions.push(instruction);
});
                }
                
                // Adicionar instrução final
                routeInstructions.push({
                    instruction: 'Chegou ao seu destino',
                    distance: '0m',
                    icon: 'fa-flag-checkered'
                });
                
                currentInstructionIndex = 0;
                updateNavigationPanel();
                
                // Remover rota anterior
                if (routeControl) {
                    map.removeLayer(routeControl);
                }
                
                // Adicionar nova rota ao mapa
                const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                routeControl = L.polyline(coordinates, {
                    color: '#2196F3',
                    weight: 6,
                    opacity: 0.8
                }).addTo(map);
                
                // Ajustar vista do mapa para mostrar toda a rota
                const bounds = L.latLngBounds([start, end]);
                map.fitBounds(bounds, { padding: [20, 20] });
                
                // Atualizar informações da rota
                document.getElementById('navDistance').textContent = `${(route.distance / 1000).toFixed(1)} km`;
                document.getElementById('navDuration').textContent = `${Math.round(route.duration / 60)} min`;
                
                console.log('Rota adicionada ao mapa com sucesso');
                
            } catch (error) {
                console.error('Erro ao calcular rota:', error);
                throw error;
            }
        }

        async function startNavigation(destLat, destLng, destName = 'Destino') {
    console.log('Iniciando navegação para:', destLat, destLng, destName);
    destinationLocation = [destLat, destLng];
    if (!userLocation) {
        try {
            showModal('A obter a sua localização...');
            userLocation = await getCurrentLocationPromise();
            updateUserLocation(userLocation);
            closeModal();
        } catch (error) {
            closeModal();
            console.error('Erro ao obter localização:', error);
            showLocationOptions(destLat, destLng, destName);
            return;
        }
    }
    
    // Centra o mapa na localização do utilizador e aplica um zoom maior (17)
    if (map && userLocation) {
        map.setView(userLocation, 17);
    }

    // Remove os balões dos pontos de localização
    if (map) {
        map.eachLayer(function (layer) {
            if (layer instanceof L.Marker && layer.options.title !== 'userMarker') {
                 layer.closePopup();
            }
        });
    }

    try {
        showModal('Calculando rota...');
        await calculateRoute(userLocation, destinationLocation);
        
        navigationActive = true;
        document.getElementById('navigationPanel').classList.add('active');
        showTab('mapa');
        
        // Adição para fazer scroll para a div do mapa de forma suave
        document.getElementById('mapa').scrollIntoView({ behavior: 'smooth' });

        // Iniciar tracking GPS contínuo
        startGPSTracking();
        
        closeModal();
        console.log('Navegação iniciada com sucesso');
    } catch (error) {
        console.error('Erro ao calcular rota:', error);
        closeModal();
        showModal('Erro ao calcular a rota. Verifique a sua ligação à internet e tente novamente.');
    }
}
        // Função para mostrar opções quando GPS não está disponível
        function showLocationOptions(destLat, destLng, destName) {
            const modal = document.getElementById('messageModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <span class="close-button" onclick="closeModal()">&times;</span>
                <h3 style="margin-bottom: 20px;">Como deseja navegar?</h3>
                <p style="margin-bottom: 20px;">Não conseguimos aceder à sua localização GPS.</p>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button onclick="setManualLocation(${destLat}, ${destLng}, '${destName}')" 
                            style="padding: 15px; background: #4facfe; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        <i class="fa-solid fa-map-marker-alt"></i> Definir localização manualmente
                    </button>
                    
                    <button onclick="openExternalNavigation(${destLat}, ${destLng}, '${destName}')" 
                            style="padding: 15px; background: #25D366; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        <i class="fa-solid fa-external-link-alt"></i> Abrir no Google Maps
                    </button>
                    
                    <button onclick="tryLocationAgain(${destLat}, ${destLng}, '${destName}')" 
                            style="padding: 15px; background: #ff9800; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        <i class="fa-solid fa-redo"></i> Tentar localização novamente
                    </button>
                    
                    <button onclick="showDirections(${destLat}, ${destLng}, '${destName}')" 
                            style="padding: 15px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        <i class="fa-solid fa-directions"></i> Ver apenas direções
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Função para definir localização manualmente
        function setManualLocation(destLat, destLng, destName) {
            closeModal();
            
            showModal('Clique no mapa para definir a sua localização atual');
            showTab('mapa');
            
            // Remover listener anterior se existir
            if (map.manualLocationListener) {
                map.off('click', map.manualLocationListener);
            }
            
            // Adicionar listener para clique no mapa
            map.manualLocationListener = function(e) {
                const clickedLocation = [e.latlng.lat, e.latlng.lng];
                updateUserLocation(clickedLocation);
                
                // Remover listener
                map.off('click', map.manualLocationListener);
                delete map.manualLocationListener;
                
                closeModal();
                
                // Iniciar navegação
                setTimeout(() => {
                    startNavigation(destLat, destLng, destName);
                }, 500);
            };
        }

        // Função para abrir navegação externa
        function openExternalNavigation(destLat, destLng, destName) {
            closeModal();
            
            // Tentar abrir no Google Maps
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}&travelmode=driving`;
            
            // Para dispositivos móveis, tentar app nativo primeiro
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                const nativeUrl = `geo:${destLat},${destLng}?q=${destLat},${destLng}(${encodeURIComponent(destName)})`;
                window.location.href = nativeUrl;
                
                // Fallback para web após 2 segundos
                setTimeout(() => {
                    window.open(googleMapsUrl, '_blank');
                }, 2000);
            } else {
                window.open(googleMapsUrl, '_blank');
            }
        }

        // Função para tentar localização novamente
        async function tryLocationAgain(destLat, destLng, destName) {
            closeModal();
            userLocation = null; // Reset para forçar nova tentativa
            await startNavigation(destLat, destLng, destName);
        }

        // Função para mostrar apenas direções sem GPS
        function showDirections(destLat, destLng, destName) {
            closeModal();
            
            // Usar centro de Viseu como ponto de partida padrão
            const viseuCenter = [40.6617747743044, -7.91556785877083];
            userLocation = viseuCenter;
            updateUserLocation(viseuCenter);
            
            // Calcular rota sem GPS tracking
            calculateRoute(viseuCenter, [destLat, destLng]).then(() => {
                navigationActive = true;
                document.getElementById('navigationPanel').classList.add('active');
                showTab('mapa');
                
                // Não iniciar GPS tracking
                showModal('Rota calculada! Note que sem GPS, a navegação não será atualizada automaticamente.');
                setTimeout(closeModal, 3000);
            }).catch(error => {
                showModal('Erro ao calcular rota: ' + error.message);
            });
        }


      // Função para atualizar o painel de navegação
function updateNavigationPanel() {
    const distanceEl = document.getElementById('navDistance');
    const durationEl = document.getElementById('navDuration');
    const instructionsEl = document.getElementById('navInstructions');

    // Limpa as instruções anteriores
    instructionsEl.innerHTML = '';
    
    // Mostra as próximas 3 instruções, garantindo que não ultrapassa o final da rota
    const numInstructionsToShow = 2;
    for (let i = 0; i < numInstructionsToShow; i++) {
        const index = currentInstructionIndex + i;
        if (index < routeInstructions.length) {
            const instruction = routeInstructions[index];
            const div = document.createElement('div');
            div.className = 'nav-instruction';
            div.style.background = 'rgba(255,255,255,0.25)';
            div.innerHTML = `
                <div class="nav-instruction-icon">
                    <i class="fa-solid ${instruction.icon}"></i>
                </div>
                <div class="nav-instruction-text">
                    ${instruction.instruction}
                </div>
                <div class="nav-instruction-distance">
                    ${instruction.distance}
                </div>
            `;
            instructionsEl.appendChild(div);
        }
    }
}
        // Função para iniciar o tracking GPS e atualizar a navegação em tempo real
function startGPSTracking() {
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
    }
    if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const newLocation = [position.coords.latitude, position.coords.longitude];
                updateUserLocation(newLocation);
                
                // Lógica para verificar a próxima instrução
                if (routeControl) {
                    const currentStep = routeControl.getPlan().getInstructions()[currentInstructionIndex];
                    if (currentStep && L.latLng(newLocation).distanceTo(L.latLng(currentStep.point)) < 25) {
                        // Se o utilizador está perto do ponto de instrução, avançar para a próxima
                        currentInstructionIndex++;
                        updateNavigationPanel();
                    }
                }
            },
            (error) => {
                console.error('Erro de tracking GPS:', error);
                // Exemplo: showLocationStatus('error', 'GPS desligado');
            },
            {
                enableHighAccuracy: true,
                maximumAge: 10000,
                timeout: 5000
            }
        );
    } else {
        console.error("Geolocation is not supported by this browser.");
    }
}
        // Função para atualizar status do GPS
        function updateGPSStatus(message, isActive) {
            const gpsStatusText = document.getElementById('gpsStatusText');
            const gpsIndicator = document.querySelector('.gps-indicator');
            
            if (gpsStatusText) {
                gpsStatusText.textContent = message;
            }
            
            if (gpsIndicator) {
                gpsIndicator.style.background = isActive ? '#4caf50' : '#ff9800';
            }
        }

        // Função para verificar progresso da navegação
        function checkNavigationProgress(newLocation) {
            // Simular lógica de progresso
            // Na implementação real, verificar distância até próxima instrução
            
            const instruction = routeInstructions[currentInstructionIndex];
            if (instruction && Math.random() > 0.8) { // Simular progresso aleatório
                currentInstructionIndex++;
                if (currentInstructionIndex >= routeInstructions.length) {
                    // Chegou ao destino
                    showModal('Chegou ao seu destino!');
                    stopNavigation();
                } else {
                    updateNavigationPanel();
                    // Opcional: anunciar próxima instrução
                    announceInstruction(routeInstructions[currentInstructionIndex].instruction);
                }
            }
        }

        // Função para anunciar instrução (voz)
        function announceInstruction(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'pt-PT';
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        // Função para recalcular a rota
async function recalculateRoute() {
    if (userLocation && destinationLocation) {
        showModal('Recalculando a rota...');
        try {
            // O comando 'await' garante que a nova rota é calculada e desenhada antes de continuar
            await calculateRoute(userLocation, destinationLocation);
            
            // Agora, com a rota já desenhada, centramos o mapa
            if (map && userLocation) {
                map.setView(userLocation, 17); // Mantém o zoom no nível 17
            }
            
            closeModal();
            console.log('Rota recalculada com sucesso');
        } catch (error) {
            console.error('Erro ao recalcular rota:', error);
            closeModal();
            showModal('Erro ao recalcular a rota. Verifique a sua ligação à internet.');
        }
    } else {
        console.warn('Localização do utilizador ou destino desconhecidos. Não é possível recalcular a rota.');
    }
}

        // Função para parar navegação
        function stopNavigation() {
            navigationActive = false;
            document.getElementById('navigationPanel').classList.remove('active');
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }
            
            currentInstructionIndex = 0;
            routeInstructions = [];
         
            console.log('Navegação parada');
        
        }

        // Função para atualizar localização do usuário
        function updateUserLocation(location) {
            userLocation = location;
            
            const userIcon = L.divIcon({
                className: 'custom-div-icon',
                html: '<div style="background-color: #007BFF; width: 1.5rem; height: 1.5rem; display: block; border-radius: 50%; border: 2px solid #FFFFFF; box-shadow: 0 0 8px #007BFF;"></div>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            if (userMarker) {
                userMarker.setLatLng(location);
            } else {
                userMarker = L.marker(location, { icon: userIcon }).addTo(map);
                userMarker.bindPopup('A tua localização');
            }
            
            if (!navigationActive) {
                map.setView(location, 15);
            }
            console.log('Localização do usuário atualizada:', location);
        }

// Função para obter localização do usuário
        async function getUserLocation() {
            try {
                showModal('A obter a sua localização...');
                const location = await getCurrentLocationPromise();
                updateUserLocation(location);
                closeModal();
                
                // Mostrar feedback sobre o método usado
                let methodMessage = '';
                switch(currentLocationMethod) {
                    case 'gps':
                        methodMessage = 'Localização GPS obtida com precisão';
                        break;
                    case 'network':
                        methodMessage = 'Localização obtida por rede Wi-Fi';
                        break;
                    case 'ip':
                        methodMessage = 'Localização aproximada obtida por IP';
                        break;
                    case 'default':
                        methodMessage = 'A usar localização padrão de Viseu';
                        break;
                }
                
                if (methodMessage && currentLocationMethod !== 'gps') {
                    setTimeout(() => {
                        showModal(methodMessage);
                        setTimeout(closeModal, 3000);
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Erro ao obter localização:', error);
                closeModal();
                showModal('Erro ao obter localização. A usar localização padrão de Viseu.');
                setTimeout(closeModal, 4000);
                
                // Usar localização padrão
                const viseuDefault = [40.6617747743044, -7.91556785877083];
                updateUserLocation(viseuDefault);
            }
        }


        // Funções para a tab PDF
        function renderPdfButtons() {
            const pdfNav = document.getElementById('pdf-nav');
            pdfNav.innerHTML = ''; // Limpa os botões existentes

            if (!window.appData || !window.appData.pdfRotas) {
                return;
            }

            window.appData.pdfRotas.forEach(pdf => {
                const button = document.createElement('button');
                button.id = `btnPdf-${pdf.id}`;
                button.textContent = pdf.nome;
                button.onclick = () => showPdf(pdf.id);
                pdfNav.appendChild(button);
            });

            // Mostra o primeiro PDF por padrão
            if (window.appData.pdfRotas.length > 0) {
                showPdf(window.appData.pdfRotas[0].id);
            }
        }

        function showPdf(pdfId) {
            const img = document.getElementById('pdf-image');
            const pdfs = window.appData.pdfRotas;

            // Remove a classe 'active' de todos os botões
            pdfs.forEach(pdf => {
                const btn = document.getElementById(`btnPdf-${pdf.id}`);
                if (btn) {
                    btn.classList.remove('active');
                }
            });

            const selectedPdf = pdfs.find(pdf => pdf.id === pdfId);
            if (selectedPdf) {
                img.src = selectedPdf.pdfUrl;
                const activeBtn = document.getElementById(`btnPdf-${pdfId}`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            } else {
                img.src = '';
                img.alt = 'Imagem não encontrada.';
            }
        }

        // Funções para a tab Lembretes
        let reminders = JSON.parse(localStorage.getItem('busReminders')) || [];

        function renderReminders() {
            const list = document.getElementById('reminderList');
            list.innerHTML = '';
            if (reminders.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">Não há lembretes definidos.</p>';
                return;
            }
            reminders.forEach((r, index) => {
                const item = document.createElement('li');
                item.className = 'reminder-item';
                let iconClass = r.type === 'ics' ? 'fa-regular fa-calendar-plus' : 'fa-solid fa-bell';
                let typeText = r.type === 'ics' ? 'ICS' : 'Notificação';

                item.innerHTML = `
                    <div class="reminder-details">
                        <h4>Lembrete (${typeText}) para a rota: ${r.routeName}</h4>
                        <p>Horário: ${r.time} - Ativado ${r.minutesBefore} minutos antes</p>
                    </div>
                    <button class="reminder-remove" onclick="removeReminder(${index})">&times;</button>
                `;
                list.appendChild(item);
            });
        }

        // Função unificada para verificar a existência de um lembrete
        function checkIfReminderExists(routeName, time) {
            return reminders.some(r => r.routeName === routeName && r.time === time);
        }

        // Função para adicionar lembrete via OneSignal
        async function addOneSignalReminder(routeName, time) {
            if (checkIfReminderExists(routeName, time)) {
                showModal('Já existe um lembrete ou um ficheiro ICS para este horário. Por favor, remova o existente para adicionar um novo.');
                return;
            }

            try {
                const userId = await OneSignal.getUserId();
                if (userId) {
                    const reminderData = {
                        playerId: userId,
                        routeName: routeName,
                        time: time,
                        minutesBefore: 10
                    };

                    const response = await fetch('https://us-central1-app-da-kika.cloudfunctions.net/scheduleNotification', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(reminderData)
                    });
                    const data = await response.json();

                    if (data.success) {
                        reminders.push({ routeName, time, minutesBefore: 10, type: 'onesignal' });
                        localStorage.setItem('busReminders', JSON.stringify(reminders));
                        showModal('Lembrete agendado com sucesso!');
                        renderReminders();
                    } else {
                        showModal(`Erro ao agendar lembrete: ${data.message || 'Erro de servidor desconhecido'}`);
                    }
                } else {
                    showModal('Por favor, ative as notificações para poder definir lembretes.');
                    OneSignal.showNativePrompt();
                }
            } catch (error) {
                console.error('Erro ao agendar lembrete:', error);
                showModal('Erro de comunicação com o servidor. Por favor, verifique a sua ligação.');
            }
        }

        function removeReminder(index) {
            reminders.splice(index, 1);
            localStorage.setItem('busReminders', JSON.stringify(reminders));
            showModal('Lembrete removido. Se adicionou este lembrete ao seu calendário, lembre-se de o remover manualmente.');
            renderReminders();
        }

        function cleanupExpiredReminders() {
            const now = new Date();
            const nowString = now.toTimeString().split(' ')[0].substring(0, 5);
            reminders = reminders.filter(r => r.time > nowString);
            localStorage.setItem('busReminders', JSON.stringify(reminders));
        }

        // Função para gerar ficheiro ICS
        function generateICS(routeName, time) {
            if (checkIfReminderExists(routeName, time)) {
                showModal('Já existe um lembrete ou um ficheiro ICS para este horário. Por favor, remova o existente para criar um novo.');
                return;
            }

            reminders.push({ routeName, time, minutesBefore: 10, type: 'ics' });
            localStorage.setItem('busReminders', JSON.stringify(reminders));
            renderReminders();
            showModal('Ficheiro ICS gerado. Por favor, importe-o para o seu calendário.');

            const now = new Date();
            const [hour, minute] = time.split(':').map(Number);
            const eventDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute);
            if (eventDate < now) {
                eventDate.setDate(eventDate.getDate() + 1);
            }

            const start = eventDate.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            const end = new Date(eventDate.getTime() + 30 * 60000).toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//gemini-app//NONSGML v1.0//EN
BEGIN:VEVENT
UID:${Date.now()}
DTSTAMP:${start}
DTSTART:${start}
DTEND:${end}
SUMMARY:Autocarro - Rota ${routeName}
DESCRIPTION:O teu autocarro para a rota ${routeName} parte às ${time}.
BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:Lembrete: Autocarro - Rota ${routeName}
TRIGGER:-PT10M
END:VALARM
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `autocarro_${routeName}_${time}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Função para partilhar no WhatsApp
        function shareWhatsApp(routeName, time) {
            const message = `Olá! O próximo autocarro para a rota ${routeName} é às ${time}.`;
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content > div').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-buttons button').forEach(button => button.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            document.getElementById(`btn${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');

            if (tabId === 'mapa') {
                if (map === null) {
                    initMap();
                } else {
                    map.invalidateSize();
                }
                getUserLocation();
            }

            if (tabId === 'lembretes') {
                renderReminders();
            }

            if (tabId === 'pontosDeInteresse') {
                renderPontosDeInteresse();
            }
        }

        function initMap() {
            const viseu = [40.6617747743044, -7.91556785877083];
            map = L.map('map').setView(viseu, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Adiciona as paragens
            if (window.appData && window.appData.paragens) {
                window.appData.paragens.forEach(paragem => {
                    const color = paragem.tipo === 'IDA' ? 'green' : 'red';
                    const icon = createMapIcon(color);
                    const marker = L.marker([paragem.lat, paragem.lng], { icon: icon })
                        .addTo(map)
                        .bindPopup(`
<div>
                                <b>Paragem:</b> ${paragem.nome}<br>
                                <button onclick="startNavigation(${paragem.lat}, ${paragem.lng}, '${paragem.nome}')" 
                                        style="margin-top: 8px; padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fa-solid fa-route"></i> Navegar
                                </button>
                            </div>
                        `);


                    const navigateToAction = () => {
                        showTab('horarios');
                        const routeSelect = document.getElementById('routeSelect');
                        routeSelect.value = paragem.nome;
                        renderSchedule(paragem.nome);
                    };

                    const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                    let clickTimer = null;

                    if (isMobile) {
                        marker.on('click', () => {
                            if (clickTimer === null) {
                                clickTimer = setTimeout(() => {
                                    marker.openPopup();
                                    clickTimer = null;
                                }, 300);
                            } else {
                                clearTimeout(clickTimer);
                                clickTimer = null;
                                navigateToAction();
                            }
                        });
                    } else {
                        marker.on('mouseover', function() { this.openPopup(); });
                        marker.on('click', navigateToAction);
                    }
                });
            }

            // Adiciona os Pontos de Interesse
            if (window.appData && window.appData.pontosDeInteresse) {
                window.appData.pontosDeInteresse.forEach(poi => {
                    const icon = createMapIcon('yellow');
                    const marker = L.marker([poi.lat, poi.lng], { icon: icon })
                        .addTo(map)
                        .bindPopup(`
<div>
                                <b>${poi.nome}</b><br>${poi.descricao}<br>
                                <button onclick="startNavigation(${poi.lat}, ${poi.lng}, '${poi.nome}')" 
                                        style="margin-top: 8px; padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fa-solid fa-route"></i> Navegar
                                </button>
                            </div>
                        `);

                    const navigateToAction = () => {
                        showTab('pontosDeInteresse');
                        const poiElement = document.getElementById(`poi-list-item-${poi.id}`);
                        if (poiElement) {
                            poiElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            poiElement.style.transition = 'background-color 0.5s ease';
                            poiElement.style.backgroundColor = '#e9d8f3';
                            setTimeout(() => { poiElement.style.backgroundColor = ''; }, 2500);
                        }
                    };

                    const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                    let clickTimer = null;
                    
                    if (isMobile) {
                         marker.on('click', () => {
                            if (clickTimer === null) {
                                clickTimer = setTimeout(() => {
                                    marker.openPopup();
                                    clickTimer = null;
                                }, 300);
                            } else {
                                clearTimeout(clickTimer);
                                clickTimer = null;
                                navigateToAction();
                            }
                        });
                    } else {
                        marker.on('mouseover', function() { this.openPopup(); });
                        marker.on('click', navigateToAction);
                    }
                });
            }
        }

        function focusOnMapPoint(lat, lng, poiName) {
            showTab('mapa'); // Muda para a aba do mapa
            
            // Dá um pequeno tempo para o mapa renderizar antes de interagir com ele
            setTimeout(() => {
                map.setView([lat, lng], 17); // Centra o mapa e aumenta o zoom
                
                // Abre o popup do marcador correspondente
                map.eachLayer(function (layer) {
                    if (layer instanceof L.Marker && layer.getLatLng().equals([lat, lng])) {
                        layer.openPopup();
                    }
                });
            }, 100);
        }
 
function filterPontosDeInteresse(query) {
            if (!window.appData || !window.appData.pontosDeInteresse) {
                return;
            }
            
            const lowerCaseQuery = query.toLowerCase();
            const filteredPois = window.appData.pontosDeInteresse.filter(poi => {
                return poi.nome.toLowerCase().includes(lowerCaseQuery) ||
                       poi.descricao.toLowerCase().includes(lowerCaseQuery);
            });
            renderPontosDeInteresse(filteredPois);
        }
       
        function renderPontosDeInteresse(pontos = window.appData.pontosDeInteresse) {
            const poiList = document.getElementById('poiList');
            poiList.innerHTML = '';

            // Se a lista de pontos de interesse não for fornecida, utiliza a lista completa dos dados
            const listaParaRenderizar = pontos || window.appData.pontosDeInteresse;

            if (!listaParaRenderizar || listaParaRenderizar.length === 0) {
                poiList.innerHTML = '<p style="text-align: center; color: #666;">Não foram encontrados pontos de interesse.</p>';
                return;
            }

            listaParaRenderizar.forEach(poi => {
                const item = document.createElement('li');
                item.className = 'poi-item';
                item.id = `poi-list-item-${poi.id}`;

                // Botão de link (só aparece se o link existir)
                let linkButton = '';
                if (poi.link && poi.link.trim() !== '') {
                    linkButton = `<button class="btn-whatsapp" onclick="window.open('${poi.link}', '_blank')" title="Abrir link"><i class="fa-solid fa-link"></i></button>`;
                }

                item.innerHTML = `
                    <div class="poi-details">
                         <h4>${poi.nome}</h4>
                        <p>${poi.descricao}</p>
                    </div>
                    <div class="action-buttons">
                        ${linkButton}
                        <button class="btn-calendar" onclick="focusOnMapPoint(${poi.lat}, ${poi.lng}, '${poi.nome}')" title="Ver no mapa">
                            <i class="fa-solid fa-map-location-dot"></i>
                        </button>
                        <button class="btn-whatsapp" onclick="startNavigation(${poi.lat}, ${poi.lng})" '${poi.nome}')" title="Navegar até aqui">
                            <i class="fa-solid fa-route"></i>
                        </button>
                    </div>
                `;
                poiList.appendChild(item);
            });
        }
        function renderSchedule(routeName) {
            const resultDiv = document.getElementById('scheduleResult');
            resultDiv.innerHTML = '';

            const schedule = window.appData.scheduleData[routeName];
            if (!schedule) {
                resultDiv.innerHTML = '<p class="no-more-buses">Horário não encontrado para a rota selecionada.</p>';
                return;
            }

            const today = new Date();
            const dayOfWeek = today.getDay();
            const currentTime = today.getHours() * 60 + today.getMinutes();

            let currentDayTimes;
            let currentDayText;

            if (dayOfWeek === 0) {
                currentDayTimes = schedule.Sunday || [];
                currentDayText = 'Domingo';
            } else if (dayOfWeek === 6) {
                currentDayTimes = schedule.weekend || [];
                currentDayText = 'Sábado';
            } else {
                currentDayTimes = schedule.weekday || [];
                currentDayText = 'Dia de Semana';
            }

            let upcomingTimes = currentDayTimes.filter(time => {
                const [h, m] = time.split(':').map(Number);
                const busTime = h * 60 + m;
                return busTime > currentTime;
            });

            let nextBusTime = null;
            let nextBusDayText = currentDayText;
            let nextUpcomingTimes = [];

            if (upcomingTimes.length > 0) {
                nextBusTime = upcomingTimes[0];
                nextUpcomingTimes = upcomingTimes.slice(1, 5);
            } else {
                let nextDay = dayOfWeek;
                let foundNextDay = false;

                while (!foundNextDay) {
                    nextDay = (nextDay + 1) % 7;
                    let nextDaySchedule;
                    let nextDayText;

                    if (nextDay === 0) {
                        nextDaySchedule = schedule.Sunday || [];
                        nextDayText = 'Próximo Domingo';
                    } else if (nextDay === 6) {
                        nextDaySchedule = schedule.weekend || [];
                        nextDayText = 'Próximo Sábado';
                    } else {
                        nextDaySchedule = schedule.weekday || [];
                        nextDayText = 'Próxima Segunda-feira';
                        if (dayOfWeek !== 6) {
                            nextDayText = 'Amanhã';
                        }
                    }

                    if (nextDaySchedule.length > 0) {
                        nextBusTime = nextDaySchedule[0];
                        nextBusDayText = nextDayText;
                        nextUpcomingTimes = nextDaySchedule.slice(1, 5);
                        foundNextDay = true;
                    }

                    if (nextDay === dayOfWeek) {
                        break;
                    }
                }
            }

            let html = '';
            if (nextBusTime) {
                html += `
                    <div class="schedule-info">
                        <div class="next-bus">
                            <h2>Próximo autocarro</h2>
                            <span class="day-indicator">${nextBusDayText}</span>
                            <div class="next-time">
                                <i class="fa-solid fa-bus"></i>
                                <span>${nextBusTime}</span>
                            </div>
                            <span class="time-remaining" id="timeRemaining-${routeName}">Calculando...</span>
                            <div class="action-buttons centered" style="margin-top: 15px;">
                                <button class="btn-reminder" onclick="addOneSignalReminder('${routeName}', '${nextBusTime}')"><i class="fa-solid fa-bell"></i></button>
                                <button class="btn-calendar" onclick="generateICS('${routeName}', '${nextBusTime}')"><i class="fa-solid fa-calendar-plus"></i></button>
                                <button class="btn-whatsapp" onclick="shareWhatsApp('${routeName}', '${nextBusTime}')"><i class="fa-brands fa-whatsapp"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `<div class="schedule-info"><p class="no-more-buses">Não há horários disponíveis para os próximos dias.</p></div>`;
            }

            if (nextUpcomingTimes.length > 0) {
                html += `
                    <div class="upcoming-times">
                        <h3>Próximos horários</h3>
                        <div class="time-list">
                `;
                nextUpcomingTimes.forEach(time => {
                    html += `
                        <div class="time-item">
                            <span>${time}</span>
                            <div class="action-buttons">
                                <button class="btn-reminder" onclick="addOneSignalReminder('${routeName}', '${time}')"><i class="fa-solid fa-bell"></i></button>
                                <button class="btn-calendar" onclick="generateICS('${routeName}', '${time}')"><i class="fa-solid fa-calendar-plus"></i></button>
                                <button class="btn-whatsapp" onclick="shareWhatsApp('${routeName}', '${time}')"><i class="fa-brands fa-whatsapp"></i></button>
                            </div>
                        </div>
                    `;
                });
                html += `
                        </div>
                    </div>
                `;
            }

            resultDiv.innerHTML = html;
            if (nextBusTime) {
                updateTimeRemaining(routeName, nextBusTime);
                setInterval(() => updateTimeRemaining(routeName, nextBusTime), 60000);
            }
        }

        function updateTimeRemaining(routeName, nextTime) {
            const now = new Date();
            const [nextHour, nextMinute] = nextTime.split(':').map(Number);
            const nextBus = new Date(now.getFullYear(), now.getMonth(), now.getDate(), nextHour, nextMinute);

            if (nextBus < now) {
                nextBus.setDate(nextBus.getDate() + 1);
            }

            const diff = nextBus.getTime() - now.getTime();
            if (diff <= 0) {
                document.getElementById(`timeRemaining-${routeName}`).innerText = "Partiu!";
                return;
            }
            const minutes = Math.floor((diff / 1000 / 60) % 60);
            const hours = Math.floor(diff / 1000 / 60 / 60);

            let timeString = '';
            if (hours > 0) {
                timeString += `${hours}h `;
            }
            timeString += `${minutes}min`;

            document.getElementById(`timeRemaining-${routeName}`).innerText = `Faltam ${timeString}`;
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
            const timeString = now.toLocaleTimeString('pt-PT', timeOptions);
            const dateString = now.toLocaleDateString('pt-PT', dateOptions);
            document.getElementById('currentTime').innerText = `${timeString} - ${dateString}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000);

            fetch('data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar o ficheiro data.json');
                    }
                    return response.json();
                })
                .then(data => {
                    window.appData = data;
                    const routeSelect = document.getElementById('routeSelect');
                    if (data.scheduleData) {
                        Object.keys(data.scheduleData).forEach(routeName => {
                            const option = document.createElement('option');
                            option.value = routeName;
                            option.textContent = routeName.replace(/-/g, ' ');
                            routeSelect.appendChild(option);
                        });
                    }

                    routeSelect.addEventListener('change', (event) => {
                        renderSchedule(event.target.value);
                    });

                    if (Object.keys(data.scheduleData || {}).length > 0) {
                        const firstRoute = Object.keys(data.scheduleData)[0];
                        routeSelect.value = firstRoute;
                        renderSchedule(firstRoute);
                    }

                    renderPdfButtons();
                    renderReminders();
                    renderPontosDeInteresse(window.appData.pontosDeInteresse);
                })
                .catch(error => {
                    console.error('Erro:', error);
                    showModal('Erro ao carregar os dados. Por favor, tente novamente mais tarde.');
                });
        });
    </script>
</body>
</html>